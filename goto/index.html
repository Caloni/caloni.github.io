<!DOCTYPE html>
<html lang="en-us" dir="ltr" itemscope itemtype="http://schema.org/Article">

  <head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Blogue do Caloni - C Resolve Tudo: goto</title>
  <meta name="author" content="" />
  <meta name="description"
        content="Para quem decide usar a linguagem C para resolver tudo, a gota da água é o goto. Ele é flexível, cabe em (quase) qualquer ponto do código e tem 1001 utilidades. O goto é o bombril da engenharia de..."/>

  <meta name="generator" content="Hugo 0.67.1" />

  
  <meta itemprop="name" content="C Resolve Tudo: goto"/>
  <meta itemprop="description"
        content="Para quem decide usar a linguagem C para resolver tudo, a gota da água é o goto. Ele é flexível, cabe em (quase) qualquer ponto do código e tem 1001 utilidades. O goto é o bombril da engenharia de..."/>
  <meta itemprop="image"
        content=""/>

  
  <meta property="og:title" content="C Resolve Tudo: goto"/>
  <meta property="og:type"
        content="article"/>
  <meta property="og:url" content="http://www.caloni.com.br/goto/"/>
  <meta property="og:image"
        content=""/>
  <meta property="og:description"
        content="Para quem decide usar a linguagem C para resolver tudo, a gota da água é o goto. Ele é flexível, cabe em (quase) qualquer ponto do código e tem 1001 utilidades. O goto é o bombril da engenharia de..."/>
  <meta property="og:site_name" content="Blogue do Caloni"/>
  <meta property="article:published_time"
        content="2019-05-28T00:00:00&#43;00:00"/>
  <meta property="article:section" content="post"/>

  
  
  <meta name="twitter:card" content="summary"/>
  <meta name="twitter:site"
        content=""/>
  <meta name="twitter:title" content="C Resolve Tudo: goto"/>
  <meta name="twitter:description"
        content="Para quem decide usar a linguagem C para resolver tudo, a gota da água é o goto. Ele é flexível, cabe em (quase) qualquer ponto do código e tem 1001 utilidades. O goto é o bombril da engenharia de..."/>
  <meta name="twitter:creator"
        content=""/>
  <meta name="twitter:image:src"
        content="
                     /images/movies.png
                   "/>

  
  <link href="" rel="alternate" type="application/rss+xml"
        title="Blogue do Caloni"/>
  <link href="" rel="feed" type="application/rss+xml"
        title="Blogue do Caloni"/>

  
  <link rel="stylesheet" type="text/css" href="/css/capsule.min.css"/>
  
  <link rel="stylesheet" type="text/css" href="/css/custom.css"/>

  
  <script>
  
    
      <!-- Google Analytics -->
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
      ga('create', 'UA-50557403-2', 'auto');
      ga('send', 'pageview');
    
  
  </script>
  <script src="/js/jquery.min.js"></script>
  <script src="/js/list.js"></script>

  
  <link rel="icon" href="/favicon.ico"/>
  </head>


  <body style="min-height:100vh;display:flex;flex-direction:column">

    <nav class="navbar has-shadow is-white"
     role="navigation" aria-label="main navigation">
  <div class="container">

    <div class="navbar-brand">
      <a class="navbar-item" title="Go to Home" href="/">
        <img alt="Brand" src="/brand.svg">
        <div class="title is-6">&nbsp;Blogue do Caloni</div>
      </a>

      
      <label class="button navbar-burger is-white" for="navbar-burger-state">
        <span></span>                               
        <span></span>
        <span></span>
      </label>
    </div>

    
    <input type="checkbox" id="navbar-burger-state"/>

    <div class="navbar-menu">
      <div class="navbar-end" style="padding: 10px;">
      <big><b>
       <a title="posts dessa categoria" href="/categories/blog">blog</a>  <a title="posts dessa categoria" href="/categories/cinema">cinema</a>  <a title="posts dessa categoria" href="/categories/code">code</a> 
      </big></b>
      </div>
    </div>

  </div>
</nav>


      
      <div class="container">
        <p class="title">C Resolve Tudo: goto</p>

        <p class="subtitle">

    <a href="https://github.com/Caloni/blog/blob/master/content/post/goto.md" title="source">
    2019-05-28
    </a>

</p>

        <div class="taglist">
            <i>Este ainda é um rascunho publicado prematuramente e está sujeito a mudanças substanciais.</i>

        </div>

        

        
          <div class="content">
            
              <p>Para quem decide usar a linguagem C para resolver tudo, a gota da água é o goto. Ele é flexível, cabe em (quase) qualquer ponto do código e tem 1001 utilidades. O goto é o bombril da engenharia de software.</p>
<p>O uso mais simples dessa importante construção da linguagem é pular de um ponto para outro do código em que esses pontos não estão diretamente relacionados, como geralmente ocorre, como sair de um laço, não entrar em um if ou selecionar um case do switch (lembrando que no caso do case do switch ele é no fundo um goto disfarçado).</p>
<pre><code>#include &lt;stdio.h&gt;

main(int argc, char* argv[])
{
    if( argc != 5 ) /* espero quatro+um (o programa) argumentos */
        goto usage;
    /*
    do something 
    do something else
    more to do
    and more
    and more
    and more
    and more
    too much lines
    ...
    finished
    */
    return 0;

    usage:
    printf(&quot;How to use: %s one two three four\n&quot;, argv[0]);
    return 1;
}

c:\Projects\goto&gt;cl goto.c
Microsoft (R) C/C++ Optimizing Compiler Version 19.22.27706.1 for x64
Copyright (C) Microsoft Corporation.  All rights reserved.

goto.c
Microsoft (R) Incremental Linker Version 14.22.27706.1
Copyright (C) Microsoft Corporation.  All rights reserved.

/out:goto.exe
goto.obj

c:\Projects\goto&gt;goto.exe
How to use: goto.exe one two three four

c:\Projects\goto&gt;
</code></pre>
<p>Claro que esse uso é trivial demais para valer a pena uma troca de fluxo tão desestruturada. Há formas mais úteis de desviar o fluxo padrão. No exemplo acima bastaria colocar todo o código que se segue dentro do grupo pertencente ao if e o goto seria desnecessário.</p>
<p>Mas, por exemplo, imagine que precisamos nos desfazer de recursos na ordem inversa ao qual vão sendo adquiridos. Pode-se aninhar indefinidamente ifs ou usar um bloco de código de unwinding que vai fechando os recursos na ordem inversa e inicia sua chamada dependendo de onde ocorreu o erro. Código é melhor para ilustrar:</p>
<pre><code>#include &lt;stdio.h&gt;

main(int argc, char* argv[])
{
    FILE *f1, *f2, *f3, *f4, *f5;

    if( ! (f1 = fopen(&quot;f1.txt&quot;, &quot;r&quot;)) ) goto end;
    if( ! (f2 = fopen(&quot;f2.txt&quot;, &quot;r&quot;)) ) goto end_f1;
    if( ! (f3 = fopen(&quot;f3.txt&quot;, &quot;r&quot;)) ) goto end_f2;
    if( ! (f4 = fopen(&quot;f4.txt&quot;, &quot;r&quot;)) ) goto end_f3;
    if( ! (f5 = fopen(&quot;f5.txt&quot;, &quot;r&quot;)) ) goto end_f4;

    /*
    code
    ...
    code
    */

    printf(&quot;closing f5\n&quot;);
    fclose(f5);
    end_f4: printf(&quot;closing f4\n&quot;); fclose(f4);
    end_f3: printf(&quot;closing f3\n&quot;); fclose(f3);
    end_f2: printf(&quot;closing f2\n&quot;); fclose(f2);
    end_f1: printf(&quot;closing f1\n&quot;); fclose(f1);
    end: ;
    /* obs: esse ponto-e-virgula final se deve ao fato que os labels do goto 
    rotulam um comando; logo, se ha um label, deve haver um comando logo
    depois (mesmo que seja nulo, no caso de ponto-e-virgula). */
}

c:\Projects\goto&gt;cl goto2.c
Microsoft (R) C/C++ Optimizing Compiler Version 19.22.27706.1 for x64
Copyright (C) Microsoft Corporation.  All rights reserved.

goto2.c
Microsoft (R) Incremental Linker Version 14.22.27706.1
Copyright (C) Microsoft Corporation.  All rights reserved.

/out:goto2.exe
goto2.obj

c:\Projects\goto&gt;goto2

c:\Projects\goto&gt;touch f1.txt

c:\Projects\goto&gt;goto2
closing f1

c:\Projects\goto&gt;touch f2.txt

c:\Projects\goto&gt;goto2
closing f2
closing f1

c:\Projects\goto&gt;touch f3.txt f4.txt f5.txt

c:\Projects\goto&gt;goto2
closing f5
closing f4
closing f3
closing f2
closing f1

c:\Projects\goto&gt;
</code></pre>
<p>Esse estilo de liberação de recursos é muito usado em códigos de kernel e software mais básico, pois simplifica a visualização e aumenta a flexibilidade. Compare com a versão estruturada:</p>
<pre><code>#include &lt;stdio.h&gt;

main(int argc, char* argv[])
{
    FILE *f1, *f2, *f3, *f4, *f5;

    if( f1 = fopen(&quot;f1.txt&quot;, &quot;r&quot;) )
    {
        if( f2 = fopen(&quot;f2.txt&quot;, &quot;r&quot;) )
        {
            if( f3 = fopen(&quot;f3.txt&quot;, &quot;r&quot;) )
            {
                if( f4 = fopen(&quot;f4.txt&quot;, &quot;r&quot;) )
                {
                    if( f5 = fopen(&quot;f5.txt&quot;, &quot;r&quot;) )
                    {
                        /*
                           code
                           ...
                           code
                         */
                        printf(&quot;closing f5\n&quot;);
                        fclose(f5);
                    }
                    printf(&quot;closing f4\n&quot;); fclose(f4);
                }
                printf(&quot;closing f3\n&quot;); fclose(f3);
            }
            printf(&quot;closing f2\n&quot;); fclose(f2);
        }
        printf(&quot;closing f1\n&quot;); fclose(f1);
    }
}

c:\Projects\goto&gt;cl nogoto2.c
Microsoft (R) C/C++ Optimizing Compiler Version 19.22.27706.1 for x64
Copyright (C) Microsoft Corporation.  All rights reserved.

nogoto2.c
Microsoft (R) Incremental Linker Version 14.22.27706.1
Copyright (C) Microsoft Corporation.  All rights reserved.

/out:nogoto2.exe
nogoto2.obj

c:\Projects\goto&gt;nogoto2
closing f5
closing f4
closing f3
closing f2
closing f1

c:\Projects\goto&gt;rm f5.txt

c:\Projects\goto&gt;nogoto2
closing f4
closing f3
closing f2
closing f1

c:\Projects\goto&gt;rm f4.txt

c:\Projects\goto&gt;nogoto2
closing f3
closing f2
closing f1

c:\Projects\goto&gt;rm f3.txt f2.txt f1.txt

c:\Projects\goto&gt;nogoto2

c:\Projects\goto&gt;
</code></pre>
<p>Aliás, esse uso do goto é a maneira de aplicar RAII em C (Resource acquisition is initialization). Implícito em linguagens como C++ e seus destrutores de objetos, em C é você que precisa fazer a faxina. E se a bagunça foi feita da direita pra esquerda a faxina deve ser feita da esquerda pra direita.</p>
<p>Esse uso super-aninhado do código me lembra do exemplo clássico de sair de muitos loops aninhados. Apenas por didática, vamos citá-lo:</p>
<pre><code>#include &lt;stdio.h&gt;

main(int argc, char* argv[])
{
    int i, j, k;

    for( i = 0; i &lt; 100; ++i )
    {
        for( j = 0; j &lt; 100; ++j )
        {
            for( k = 0; k &lt; 100; ++k )
            {
                if( k == 10 )
                    /* break... ops. no. to the outer world */
                    goto outer_world;
            }
        }
    }

    outer_world:
    ;
}
</code></pre>
<p>Comentei no começo do texto que os cases do switch são labels de goto disfarçados. E são mesmo. Um dos algoritmos mais famosos de transformação de loop chamado Duff&rsquo;s device junta um do-while com switch e realiza uma cópia de buffer com um número de bytes variável:</p>
<pre><code>send(to, from, count)
register short *to, *from;
register count;
{
    register n = (count + 7) / 8;
    switch (count % 8) {
    case 0: do { *to = *from++;
    case 7:      *to = *from++;
    case 6:      *to = *from++;
    case 5:      *to = *from++;
    case 4:      *to = *from++;
    case 3:      *to = *from++;
    case 2:      *to = *from++;
    case 1:      *to = *from++;
            } while (--n &gt; 0);
    }
}
</code></pre>
<p>O que está acontecendo no código acima: é possível inserir qualquer tipo de mudança de fluxo dentro do switch. Duff aproveitou essa particularidade da linguagem para produzir jumps que poderiam ser feitos em assembly. Dependendo do resto da divisão por oito o salto é realizado para um case diferente, que executará parte do laço até o while comparador final. A vantagem desse tipo de abordagem é que evita-se sair da programação estruturada, e muito menos precisa-se apelar para o assembly.</p>
<p>Esse código também seria possível de ser feito com o goto clássico, mas note que nesse caso ele fica mais verboso, pois é necessário fazer um if diferente para cada condição.</p>
<pre><code>#include &lt;stdio.h&gt;

send(to, from, count)
register short *to, *from;
register count;
{
    register n = (count + 7) / 8;
    if (count % 8 == 0 ) goto case_0;
    if (count % 8 == 7 ) goto case_7;
    if (count % 8 == 6 ) goto case_6;
    if (count % 8 == 5 ) goto case_5;
    if (count % 8 == 4 ) goto case_4;
    if (count % 8 == 3 ) goto case_3;
    if (count % 8 == 2 ) goto case_2;
    if (count % 8 == 1 ) goto case_1;
    case_0: do { *to++ = *from++; /* estou incrementando `to` tambem    */
    case_7:      *to++ = *from++; /* porque esta nao eh uma memoria     */
    case_6:      *to++ = *from++; /* de hardware que se auto incrementa */
    case_5:      *to++ = *from++;
    case_4:      *to++ = *from++;
    case_3:      *to++ = *from++;
    case_2:      *to++ = *from++;
    case_1:      *to++ = *from++;
            } while (--n &gt; 0);
}

main()
{
    short to[10] = { 0, 0, 0, 0, 0, 0, 0, 0, 0, 0 };
    short from[10] = { 0, 1, 2, 3, 4, 5, 6, 7, 8, 9 };
    int i;
    send(to, from, 10);
    for( i = 0; i &lt; 10; ++i )
        printf(&quot;%d &quot;, to[i]);
    printf(&quot;\n&quot;);
}
</code></pre>
<p>Caso você tenha estranhada a definição inicial da função, ela é como se definia os argumentos em linguagem C antes do padrão ANSI, com os nomes e logo em seguida a declaração das variáveis como se fossem locais (porque de fato elas são, embora sua inicialização seja feita antes da chamada). Como este código data dos anos 80 e como o padrão só foi finalizado em 89, percebe-se que ainda se usava o formato antigo no código.</p>
<p>Passemos para o próximo uso: código infinito. Esse é um uso clássico, e diferente do uso degenerado de laços em que a condição é sempre verdadeira (while(true), for(;;)) usando o goto fica bem-documentado que o objetivo é ficar eternamente nesse loop. Um laço infinito que eu me lembro é quando dá tela azul no Windows. O código-fonte do kernel era algo mais ou menos assim:</p>
<pre><code>/* ... */
gerarDump();
mudarParaVga();

while( true )
    ; /* that's all, folks */
/* ... */
</code></pre>
<p>Os programadores usaram o apelo clássico do while. Sem motivo, pois goto é usado direto como RAII (já explicado acima). A maneira procedural de fazer seria assim:</p>
<pre><code>main()
{
    infinite:
    goto infinite;
}

c:\Projects\goto&gt;cl goto4.c
Microsoft (R) C/C++ Optimizing Compiler Version 19.22.27706.1 for x64
Copyright (C) Microsoft Corporation.  All rights reserved.

goto4.c
Microsoft (R) Incremental Linker Version 14.22.27706.1
Copyright (C) Microsoft Corporation.  All rights reserved.

/out:goto4.exe
goto4.obj

c:\Projects\goto&gt;goto4
...
...
tudo esta tao escuro...
</code></pre>
<p>Isso lembra outra utilidade do goto que você pode anotar no seu caderninho: ele pode voltar o fluxo, de baixo para cima.</p>
<p>Esse último exemplo é um dos programas C mais lindos do universo. Sua única instrução é o comando rotulado por infinite e referencia ele mesmo. É quase o salto incondicional do assembly, materializado na linguagem mais elegante jamais criada em nossa realidade.</p>

            

          </div>

        <div class="taglist">
            
    
        
        
            <a href="https://github.com/Caloni/goto" style="text-decoration: underline;">goto()</a>
        
        
        
        
        <a href="/blob/master/data/post/goto.toml" style="text-decoration: underline;">references</a>
    
      [<a href="/categories/code">code</a>] 
      [<a href="/tags/draft">draft</a>] 
    
    <a href="https://twitter.com/intent/tweet?text=Para%20quem%20decide%20usar%20a%20linguagem%20C%20para%20resolver%20tudo%2c%20a%20gota%20da%20%c3%a1gua%20%c3%a9%20o%20goto.%20Ele%20%c3%a9%20flex%c3%advel%2c%20cabe%20em%20%28quase%29...%20http%3a%2f%2fwww.caloni.com.br%2fgoto%2f from @caloni " style="text-decoration: underline;" title="Twitter">twitter</big></a>


        </div>

        <div class="navigation-bottom">
            <span style="float: right;"><a href="http://www.caloni.com.br/albergue-espanhol/">Albergue Espanhol<span class="icon"><i class="fa fa-arrow-right"></i></span></a></span>
<span style="float: left;"><a href="http://www.caloni.com.br/o-castelo-de-cagliostro/"><span class="icon"><i class="fa fa-arrow-left"></i></span>O Castelo de Cagliostro</a></span>

        </div>

      </div>

    <footer class="footer">
  <div class="container">
    <span style="float: right;"><i style="font-size: small;">Blogue do Caloni 2020. Copyright é invenção do capitalismo burguês opressor. Todos os direitos não serão reservados.</i></span>
  </div>
</footer>

  </body>

</html>
