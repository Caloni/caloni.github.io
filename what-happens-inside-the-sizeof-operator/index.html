<!DOCTYPE html>
<html lang="en-us" dir="ltr" itemscope itemtype="http://schema.org/Article">

  <head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Blogue do Caloni - What happens inside the sizeof operator</title>
  <meta name="author" content="" />
  <meta name="description"
        content="The question: how to get the size of a struct member without declaring it as a variable in memory? In pseudocode:
static const size_t FIELD_SIZE_MSGID = 15;

struct FEEDER_RECORD_HEADER
{
   char..."/>

  <meta name="generator" content="Hugo 0.67.1" />

  
  <meta itemprop="name" content="What happens inside the sizeof operator"/>
  <meta itemprop="description"
        content="The question: how to get the size of a struct member without declaring it as a variable in memory? In pseudocode:
static const size_t FIELD_SIZE_MSGID = 15;

struct FEEDER_RECORD_HEADER
{
   char..."/>
  <meta itemprop="image"
        content=""/>

  
  <meta property="og:title" content="What happens inside the sizeof operator"/>
  <meta property="og:type"
        content="article"/>
  <meta property="og:url" content="http://www.caloni.com.br/what-happens-inside-the-sizeof-operator/"/>
  <meta property="og:image"
        content=""/>
  <meta property="og:description"
        content="The question: how to get the size of a struct member without declaring it as a variable in memory? In pseudocode:
static const size_t FIELD_SIZE_MSGID = 15;

struct FEEDER_RECORD_HEADER
{
   char..."/>
  <meta property="og:site_name" content="Blogue do Caloni"/>
  <meta property="article:published_time"
        content="2007-07-16T00:00:00&#43;00:00"/>
  <meta property="article:section" content="post"/>

  
  
  <meta name="twitter:card" content="summary"/>
  <meta name="twitter:site"
        content=""/>
  <meta name="twitter:title" content="What happens inside the sizeof operator"/>
  <meta name="twitter:description"
        content="The question: how to get the size of a struct member without declaring it as a variable in memory? In pseudocode:
static const size_t FIELD_SIZE_MSGID = 15;

struct FEEDER_RECORD_HEADER
{
   char..."/>
  <meta name="twitter:creator"
        content=""/>
  <meta name="twitter:image:src"
        content="
                     /images/movies.png
                   "/>

  
  <link href="" rel="alternate" type="application/rss+xml"
        title="Blogue do Caloni"/>
  <link href="" rel="feed" type="application/rss+xml"
        title="Blogue do Caloni"/>

  
  <link rel="stylesheet" type="text/css" href="/css/capsule.min.css"/>
  
  <link rel="stylesheet" type="text/css" href="/css/custom.css"/>

  
  <script>
  
    
      <!-- Google Analytics -->
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
      ga('create', 'UA-50557403-2', 'auto');
      ga('send', 'pageview');
    
  
  </script>
  <script src="/js/jquery.min.js"></script>
  <script src="/js/list.js"></script>

  
  <link rel="icon" href="/favicon.ico"/>
  </head>


  <body style="min-height:100vh;display:flex;flex-direction:column">

    <nav class="navbar has-shadow is-white"
     role="navigation" aria-label="main navigation">
  <div class="container">

    <div class="navbar-brand">
      <a class="navbar-item" title="Go to Home" href="/">
        <img alt="Brand" src="/brand.svg">
        <div class="title is-6">&nbsp;Blogue do Caloni</div>
      </a>

      
      <label class="button navbar-burger is-white" for="navbar-burger-state">
        <span></span>                               
        <span></span>
        <span></span>
      </label>
    </div>

    
    <input type="checkbox" id="navbar-burger-state"/>

    <div class="navbar-menu">
      <div class="navbar-end" style="padding: 10px;">
      <big><b>
       <a title="posts dessa categoria" href="/categories/blog">blog</a>  <a title="posts dessa categoria" href="/categories/cinema">cinema</a>  <a title="posts dessa categoria" href="/categories/code">code</a> 
      </big></b>
      </div>
    </div>

  </div>
</nav>


      
      <div class="container">
        <p class="title">What happens inside the sizeof operator</p>

        <p class="subtitle">

    <a href="https://github.com/Caloni/blog/blob/master/content/post/what-happens-inside-the-sizeof-operator.md" title="source">
    2007-07-16
    </a>

</p>

        <div class="taglist">
            <i>Este ainda é um rascunho publicado prematuramente e está sujeito a mudanças substanciais.</i>

        </div>

        

        
          <div class="content">
            
              <p>The question: how to get the size of a struct member without declaring it as a variable in memory? In pseudocode:</p>
<pre><code>static const size_t FIELD_SIZE_MSGID = 15;

struct FEEDER_RECORD_HEADER
{
   char MessageID[FIELD_SIZE_MSGID];
   char MessageIndex[10];
};

// error C2143: syntax error : missing ')' before '.'
char MessageIndexBuffer[sizeof(FEEDER_RECORD_HEADER.MessageIndex) + 1];

// error C2070: '': illegal sizeof operand
char MessageIndexBuffer[sizeof(FEEDER_RECORD_HEADER::MessageIndex) + 1]; 
</code></pre>
<p>In this first try (even being a nice one) we can clearly see by instinct that the construction is not supposed to work. The compiler error is not even clear. The member access operator (the point sign) needs to have as its left some variable or constant of the same type of the struct. Since the operand is the type itself, there is no deal.</p>
<p>The second test is more feasible. Even the compiler can alert us. We have accessed the right member in the right struct but in the wrong way. As we&rsquo;re not using a static member or, in other words, a class variable, we can&rsquo;t access the member by scope. We need an object. But in order to have an object we are supposed to have to create one, and this is exactly what is not allowed in our solution.</p>
<p>This kind of problem reminds me about a curious feature inside the sizeof operator: it doesn&rsquo;t evaluate the expressions used as operands. How&rsquo;s that? Well, as the sizeof main purpose is to provide us the memory size filled by the expression, it simply doesn&rsquo;t make sense to execute the expression. We just need to note that the language we&rsquo;re talking about defends eficiency and clarity as main principles. If you want to execute the expression, we do it without using sizeof operator.</p>
<p>So, now we know that everything put inside a sizeof is not going to be executed in fact. It works somewhat like the c++ &ldquo;dead zone&rdquo;: is the place where - talking about executable code - nothing runs. That means we can build a object inside sizeof that nothing is going to happen, except for the expression size. Let&rsquo;s look the resulting assembly:</p>
<pre><code>_sz = sizeof( (new FEEDER_RECORD_HEADER)-&gt;MessageID ); // this...
mov dword ptr [sz], 0Fh ; ... is translated into this
</code></pre>
<p>Another way to do the same thing (for those who can&rsquo;t bear the use of operator new delete, seeing the code as a memory leak):</p>
<pre><code>sz = sizeof( ((FEEDER_RECORD_HEADER*)0)-&gt;MessageID ); // this...
mov dword ptr [sz], 0Fh ; ... is translated into this
</code></pre>
<p>Conclusion: the operator new is called and nothing happens. We got what we wanted. That shows us one more time that the little details built inside a language layout are only very important in the exact time we need them.</p>

            

          </div>

        <div class="taglist">
            
    
      [<a href="/categories/code">code</a>] 
      [<a href="/tags/draft">draft</a>] 
    
    <a href="https://twitter.com/intent/tweet?text=The%20question%3a%20how%20to%20get%20the%20size%20of%20a%20struct%20member%20without%20declaring%20it%20as%20a%20variable%20in%20memory%3f%20In%20pseudocode%3a%0astatic...%20http%3a%2f%2fwww.caloni.com.br%2fwhat-happens-inside-the-sizeof-operator%2f from @caloni " style="text-decoration: underline;" title="Twitter">twitter</big></a>


        </div>

        <div class="navigation-bottom">
            <span style="float: right;"><a href="http://www.caloni.com.br/como-ser-um-melhor-desenvolvedor-nos-proximos-seis-meses/">Como ser um melhor desenvolvedor nos próximos seis meses<span class="icon"><i class="fa fa-arrow-right"></i></span></a></span>
<span style="float: left;"><a href="http://www.caloni.com.br/desejo-insano-de-programar-no-kernel/"><span class="icon"><i class="fa fa-arrow-left"></i></span>Desejo insano de programar no kernel</a></span>

        </div>

      </div>

    <footer class="footer">
  <div class="container">
    <span style="float: right;"><i style="font-size: small;">Blogue do Caloni 2020. Copyright é invenção do capitalismo burguês opressor. Todos os direitos não serão reservados.</i></span>
  </div>
</footer>

  </body>

</html>
