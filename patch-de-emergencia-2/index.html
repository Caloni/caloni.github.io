<!DOCTYPE html>
<html lang="en-us" dir="ltr" itemscope itemtype="http://schema.org/Article">

  <head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Blogue do Caloni - Patch de emergência 2</title>
  <meta name="author" content="" />
  <meta name="description"
        content="No artigo anterior fizemos um patch rapidinho na memória se aproveitando de um Sleep nojento que o código nos forneceu.
E se não houvesse Sleep?
As chances de estarmos escrevendo no momento em que a..."/>

  <meta name="generator" content="Hugo 0.67.1" />

  
  <meta itemprop="name" content="Patch de emergência 2"/>
  <meta itemprop="description"
        content="No artigo anterior fizemos um patch rapidinho na memória se aproveitando de um Sleep nojento que o código nos forneceu.
E se não houvesse Sleep?
As chances de estarmos escrevendo no momento em que a..."/>
  <meta itemprop="image"
        content=""/>

  
  <meta property="og:title" content="Patch de emergência 2"/>
  <meta property="og:type"
        content="article"/>
  <meta property="og:url" content="http://www.caloni.com.br/patch-de-emergencia-2/"/>
  <meta property="og:image"
        content=""/>
  <meta property="og:description"
        content="No artigo anterior fizemos um patch rapidinho na memória se aproveitando de um Sleep nojento que o código nos forneceu.
E se não houvesse Sleep?
As chances de estarmos escrevendo no momento em que a..."/>
  <meta property="og:site_name" content="Blogue do Caloni"/>
  <meta property="article:published_time"
        content="2010-11-09T00:00:00&#43;00:00"/>
  <meta property="article:section" content="post"/>

  
  
  <meta name="twitter:card" content="summary"/>
  <meta name="twitter:site"
        content=""/>
  <meta name="twitter:title" content="Patch de emergência 2"/>
  <meta name="twitter:description"
        content="No artigo anterior fizemos um patch rapidinho na memória se aproveitando de um Sleep nojento que o código nos forneceu.
E se não houvesse Sleep?
As chances de estarmos escrevendo no momento em que a..."/>
  <meta name="twitter:creator"
        content=""/>
  <meta name="twitter:image:src"
        content="
                     /images/movies.png
                   "/>

  
  <link href="" rel="alternate" type="application/rss+xml"
        title="Blogue do Caloni"/>
  <link href="" rel="feed" type="application/rss+xml"
        title="Blogue do Caloni"/>

  
  <link rel="stylesheet" type="text/css" href="/css/capsule.min.css"/>
  
  <link rel="stylesheet" type="text/css" href="/css/custom.css"/>

  
  <script>
  
    
      <!-- Google Analytics -->
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
      ga('create', 'UA-50557403-2', 'auto');
      ga('send', 'pageview');
    
  
  </script>
  <script src="/js/jquery.min.js"></script>
  <script src="/js/list.js"></script>

  
  <link rel="icon" href="/favicon.ico"/>
  </head>


  <body style="min-height:100vh;display:flex;flex-direction:column">

    <nav class="navbar has-shadow is-white"
     role="navigation" aria-label="main navigation">
  <div class="container">

    <div class="navbar-brand">
      <a class="navbar-item" title="Go to Home" href="/">
        <img alt="Brand" src="/brand.svg">
        <div class="title is-6">&nbsp;Blogue do Caloni</div>
      </a>

      
      <label class="button navbar-burger is-white" for="navbar-burger-state">
        <span></span>                               
        <span></span>
        <span></span>
      </label>
    </div>

    
    <input type="checkbox" id="navbar-burger-state"/>

    <div class="navbar-menu">
      <div class="navbar-end" style="padding: 10px;">
      <big><b>
       <a title="posts dessa categoria" href="/categories/blog">blog</a>  <a title="posts dessa categoria" href="/categories/cinema">cinema</a>  <a title="posts dessa categoria" href="/categories/code">code</a> 
      </big></b>
      </div>
    </div>

  </div>
</nav>


      
      <div class="container">
        <p class="title">Patch de emergência 2</p>

        <p class="subtitle">
<i>

    <a href="https://github.com/Caloni/blog/blob/master/content/post/patch-de-emergencia-2.md" title="source">
    2010-11-09
    </a>

</p>

        <div class="taglist">
            <i>Este ainda é um rascunho publicado prematuramente e está sujeito a mudanças substanciais.</i>

        </div>

        

        
          <div class="content">
            
              <p>No artigo anterior fizemos um patch rapidinho na memória se aproveitando de um Sleep nojento que o código nos forneceu.</p>
<p>E se não houvesse Sleep?</p>
<p>As chances de estarmos escrevendo no momento em que a função está sendo executada são tremendas, de forma que não poderíamos sobrescrevê-la sem correr o risco de um crash.</p>
<p>Uma solução alternativa para isso é alocar um novo pedaço de memória para a versão corrigida e trocar o endereço de chamada na função main.</p>
<pre><code>windbg criticalservice3.exe

0:000&gt; uf DoProcess
criticalservice3!DoProcess [s:\docs\artigos\criticalservice3.cpp @ 8]:
    8 00401020 55              push    ebp
   ...
   12 0040107d 5d              pop     ebp
   12 0040107e c3              ret
0:000&gt; .writemem DoProcess.func 00401020 0040107e
Writing 5f bytes.


windbg -pvr -pn criticalservice2.exe

0:000&gt; .dvalloc 0x5f
Allocated 1000 bytes starting at 00030000
0:000&gt; .readmem DoProcess.func 00030000 L5f
Reading 5f bytes.
0:000&gt; uf 00030000
00030000 55              push    ebp
...
0003005d 5d              pop     ebp
0003005e c3              ret
</code></pre>
<p>Antes de trocarmos o endereço dentro do main precisamos &ldquo;consertar&rdquo; a função copiada. Ela está usando as funções globais rand e printf, e as chamadas usam offsets relativos. Como agora a função está em outro offset, temos que reconstruir as chamadas:</p>
<pre><code>00401026 e8da000000      call    criticalservice3!rand (00401105)
00030006 e8da000000      call    000300e5

0:000&gt; a 00030006
00030006 call 0x00401105
call 0x00401105
0003000b 

00401073 e852000000      call    criticalservice3!printf (004010ca)
00030053 e852000000      call    000300aa

0:000&gt; a 00030053
00030053 call 0x004010ca
call 0x004010ca
00030058
</code></pre>
<p>Agora a função está pronta para ser usada.</p>
<pre><code>0:000&gt; uf 00030000
00030000 55              push    ebp
00030001 8bec            mov     ebp,esp
00030003 83ec0c          sub     esp,0Ch
00030006 e8fa103d00      call    criticalservice2!rand (00401105)
0003000b 99              cdq
...
0003004e 6828a04000      push    offset criticalservice2!GetSystemInfo
00030053 e872103d00      call    criticalservice2!printf (004010ca)
00030058 83c40c          add     esp,0Ch
0003005b 8be5            mov     esp,ebp
0003005d 5d              pop     ebp
0003005e c3              ret

0:000&gt; uf main
criticalservice2!main [s:\docs\artigos\criticalservice2.cpp @ 16]:
   16 00401080 55              push    ebp
...
criticalservice2!main+0x1f [s:\docs\artigos\criticalservice2.cpp @ 21]:
   21 0040109f e861ffffff      call    criticalservice2!ILT+0(?DoProcessYAXXZ) (00401005)
   22 004010a4 ebf0            jmp     criticalservice2!main+0x16 (00401096)
</code></pre>
<p>É nessa parte que trocaremos o endereço o endereço 00401005 pela memória alocada. Note que essa escrita é muito rápida e o programa lê esse endereço por muito pouco tempo se compararmos com todas as intruções que são executadas. No entanto, essa escrita não é atômica, e mesmo que as chances sejam extremamente remotas, ainda assim pode haver uma colisão no acesso à essa parte.</p>
<p>É salutar rezar por 10 segundos.</p>
<pre><code>0:000&gt; a 0040109f
0040109f call 0x00030000
call 0x00030000
004010a4
</code></pre>
<p>E voilà! A partir do momento em que digitei o call seguido de enter, a função nova já começou a operar em cima do processo ainda rodando. Se quisermos voltar a função antiga, sem problemas:</p>
<pre><code>0:000&gt; a 0040109f
0040109f call 0x00401005
call 0x00401005
004010a4
</code></pre>
<p>Não façam isso em casa, crianças ;)</p>

            

          </div>

        <div class="taglist">
            
    
      [<a href="/categories/code">code</a>] 
      [<a href="/tags/draft">draft</a>] 
    
    <a href="https://twitter.com/intent/tweet?text=No%20artigo%20anterior%20fizemos%20um%20patch%20rapidinho%20na%20mem%c3%b3ria%20se%20aproveitando%20de%20um%20Sleep%20nojento%20que%20o%20c%c3%b3digo%20nos%20forneceu....%20http%3a%2f%2fwww.caloni.com.br%2fpatch-de-emergencia-2%2f from @caloni " style="text-decoration: underline;" title="Twitter">twitter</big></a>


        </div>

        <div class="navigation-bottom">
            <span style="float: right;"><a href="http://www.caloni.com.br/red-aposentados-e-perigosos/">Red Aposentados e Perigosos<span class="icon"><i class="fa fa-arrow-right"></i></span></a></span>
<span style="float: left;"><a href="http://www.caloni.com.br/patch-de-emergencia/"><span class="icon"><i class="fa fa-arrow-left"></i></span>Patch de emergência</a></span>

        </div>

      </div>

    <footer class="footer">
  <div class="container">
    <span style="float: right;"><i style="font-size: small;">Blogue do Caloni 2020. Copyright é invenção do capitalismo burguês opressor. Todos os direitos não serão reservados.</i></span>
  </div>
</footer>

  </body>

</html>
