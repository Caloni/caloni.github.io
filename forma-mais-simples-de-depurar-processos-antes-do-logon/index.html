<!DOCTYPE html>
<html lang="en-us" dir="ltr" itemscope itemtype="http://schema.org/Article">

  <head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Blogue do Caloni - Forma Mais Simples De Depurar Processos Antes Do Logon</title>
  <meta name="author" content="" />
  <meta name="description"
        content="No post anterior sobre debug eu havia me focado mais na depuração de processos remotos no Visual Studio 2003 de maneira convencional. Aqui eu vou abordar o assunto de uma maneira menos convencional:..."/>

  <meta name="generator" content="Hugo 0.67.1" />

  
  <meta itemprop="name" content="Forma Mais Simples De Depurar Processos Antes Do Logon"/>
  <meta itemprop="description"
        content="No post anterior sobre debug eu havia me focado mais na depuração de processos remotos no Visual Studio 2003 de maneira convencional. Aqui eu vou abordar o assunto de uma maneira menos convencional:..."/>
  <meta itemprop="image"
        content=""/>

  
  <meta property="og:title" content="Forma Mais Simples De Depurar Processos Antes Do Logon"/>
  <meta property="og:type"
        content="article"/>
  <meta property="og:url" content="http://www.caloni.com.br/forma-mais-simples-de-depurar-processos-antes-do-logon/"/>
  <meta property="og:image"
        content=""/>
  <meta property="og:description"
        content="No post anterior sobre debug eu havia me focado mais na depuração de processos remotos no Visual Studio 2003 de maneira convencional. Aqui eu vou abordar o assunto de uma maneira menos convencional:..."/>
  <meta property="og:site_name" content="Blogue do Caloni"/>
  <meta property="article:published_time"
        content="2017-07-27T00:00:00&#43;00:00"/>
  <meta property="article:section" content="post"/>

  
  
  <meta name="twitter:card" content="summary"/>
  <meta name="twitter:site"
        content=""/>
  <meta name="twitter:title" content="Forma Mais Simples De Depurar Processos Antes Do Logon"/>
  <meta name="twitter:description"
        content="No post anterior sobre debug eu havia me focado mais na depuração de processos remotos no Visual Studio 2003 de maneira convencional. Aqui eu vou abordar o assunto de uma maneira menos convencional:..."/>
  <meta name="twitter:creator"
        content=""/>
  <meta name="twitter:image:src"
        content="
                     /images/movies.png
                   "/>

  
  <link href="" rel="alternate" type="application/rss+xml"
        title="Blogue do Caloni"/>
  <link href="" rel="feed" type="application/rss+xml"
        title="Blogue do Caloni"/>

  
  <link rel="stylesheet" type="text/css" href="/css/capsule.min.css"/>
  
  <link rel="stylesheet" type="text/css" href="/css/custom.css"/>

  
  <script>
  
    
      <!-- Google Analytics -->
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
      ga('create', 'UA-50557403-2', 'auto');
      ga('send', 'pageview');
    
  
  </script>
  <script src="/js/jquery.min.js"></script>
  <script src="/js/list.js"></script>

  
  <link rel="icon" href="/favicon.ico"/>
  </head>


  <body style="min-height:100vh;display:flex;flex-direction:column">

    <nav class="navbar has-shadow is-white"
     role="navigation" aria-label="main navigation">
  <div class="container">

    <div class="navbar-brand">
      <a class="navbar-item" title="Go to Home" href="/">
        <img alt="Brand" src="/brand.svg">
        <div class="title is-6">&nbsp;Blogue do Caloni</div>
      </a>

      
      <label class="button navbar-burger is-white" for="navbar-burger-state">
        <span></span>                               
        <span></span>
        <span></span>
      </label>
    </div>

    
    <input type="checkbox" id="navbar-burger-state"/>

    <div class="navbar-menu">
      <div class="navbar-end" style="padding: 10px;">
      <big><b>
       <a title="posts dessa categoria" href="/categories/blog">blog</a>  <a title="posts dessa categoria" href="/categories/cinema">cinema</a>  <a title="posts dessa categoria" href="/categories/code">code</a> 
       <a href="/caloni"><span class="icon"><i class="fa fa-user"></i></a> <a href="index.xml"><span class="icon"><i class="fa fa-rss"></i></a>
      </big></b>
      </div>
    </div>

  </div>
</nav>


      
      <div class="container">
        <p class="title">Forma Mais Simples De Depurar Processos Antes Do Logon</p>

        <p class="subtitle">
<i>

    <a href="https://github.com/Caloni/post/commits/master/forma-mais-simples-de-depurar-processos-antes-do-logon.md" title="History">
    2017-07-27
    </a>

<span class="icon"><i class="fa fa-clock-o"></span></i>3 </i>
 <span class="icon"><i class="fa fa-pencil"></i></span><a href="https://github.com/Caloni/post/blob/master/forma-mais-simples-de-depurar-processos-antes-do-logon.md" title="GitHub">576</a>
</p>

        <div class="taglist">
            <i>Este ainda é um rascunho publicado prematuramente e está sujeito a mudanças substanciais.</i>

        </div>

        

        
          <div class="content">
            
              <p>No post anterior sobre debug eu havia me focado mais na depuração de processos remotos no Visual Studio 2003 de maneira convencional. Aqui eu vou abordar o assunto de uma maneira menos convencional: usando o Visual Studio 2017 mais novo e depurando uma DLL (C++) que é carregada por um serviço antes do logon no Windows 7.</p>
<p>Em primeiro lugar, como vimos anteriormente, a ponta server do depurador é um programa que você executa com alguns parâmetros e ele fica escutando em uma porta. Simples assim. Para que isso funcione antes do logon é necessário instalar esse programa como um serviço. Tanto no caso de depuradores mais antigos (msvCmon) quando nos mais novos (msvSmon) há sempre um executável com alguns parâmetros passados via linha de comando.</p>
<p>O depurador do Visual Studio mais novo fica em sua pasta de instalação Program Files, etc, Microsoft Visual Studio, 2017, Enterprise, Common7, IDE, Remote Debugger ou derivados. Dentro dessa pasta há subpastas para cada arquitetura, x64 ou x86. É essa pasta que deve ser copiada para a máquina que será depurada. Se você estiver depurando um processo 32 bits, use o x86; do contrário, vá de x64.</p>
<p>No caso do msvsmon, se executado com /? (padrão entre programas Windows) ele abre um pequeno help com a ajuda necessária para executar os parâmetros corretos. No caso o comando maroto é o seguinte:</p>
<pre><code>msvsmon.exe /timeout 999999 /anyuser /silent /noauth
</code></pre>
<p>E para transformar em um serviço podemos usar o NSSM, já visto em outros artigos.</p>
<pre><code>nssm.exe install Msvsmon msvsmon.exe /timeout 999999 /anyuser /silent /noauth
</code></pre>
<p>Isso cria um serviço de start automático que irá iniciar o debugger na ponta server quietinho, sem janelas, só escutando e esperando o Visual Studio atachar.</p>
<p>Para este exemplo vamos usar um programa console que será convertido, assim como o msvsmon, em serviço, e uma DLL que ele carrega, chamando dois métodos; um de start, outro de stop. Nosso objetivo aqui é começar a depurar a DLL logo em seu início, na chamada do start.</p>
<pre><code>#include &lt;iostream&gt;
#include &lt;windows.h&gt;

int main()
{
    if( HMODULE dll = LoadLibraryA(&quot;DLL&quot;) )
    {
        void (*start)(), (*stop)();
        *((FARPROC*)&amp;start) = GetProcAddress(dll, &quot;DLL_Start&quot;);
        *((FARPROC*)&amp;stop) = GetProcAddress(dll, &quot;DLL_Stop&quot;);
        if( start )
            start();
        std::cout &lt;&lt; &quot;Type &lt;enter&gt; to exit\n&quot;;
        std::cin.get();
        if( stop )
            stop();
        FreeLibrary(dll);
    }
    else std::cout &lt;&lt; &quot;DLL not found\n&quot;;
}
</code></pre>
<p>As funções de start e stop não fazem nada, apenas imprimem um passou-por-aqui:</p>
<pre><code>#include &quot;DLL.h&quot;
#include &lt;iostream&gt;

void DLL_Start()
{
    std::cout &lt;&lt; &quot;DLL started\n&quot;;
}

void DLL_Stop()
{
    std::cout &lt;&lt; &quot;DLL stopped\n&quot;;
}
</code></pre>
<p>Todo o projeto está no GitHub para baixar e compilar você mesmo.</p>
<p>Depois de copiar Service.exe e DLL.dll para a máquina-alvo (e não se esquecer de instalar as dependências) instalar da mesma forma com que foi instalado o msvsmon:</p>
<pre><code>nssm.exe install Service service.exe
</code></pre>
<p>Agora ache o IP da máquina-alvo e vá em Debug, Attach to Process (Ctrl+Alt+P) no Visual Studio, modo remoto e digite o IP.</p>
<pre><code>cmd /k ipconfig | find &quot;192&quot;
</code></pre>
<p>Lembre-se de iniciar o serviço.</p>
<p>Após esse teste podemos modificar a DLL para aguardar por um depurador:</p>
<pre><code>#include &lt;windows.h&gt;

void DLL_Start()
{
    while( ! IsDebuggerPresent() )
        Sleep(1000);
    std::cout &lt;&lt; &quot;DLL started\n&quot;;
}
</code></pre>
<p>Depois que houver o attach você irá continuar a execução. Portanto, coloque um breakpoint logo depois. E depois que isso funcionar já é possível iniciar sua depuração antes da tela de login. Os serviços executarão, e sua DLL estará aguardando um debugger ser atachado. Se houver necessidade é possível deixar esse modo de espera configurável, por timeout, etc.</p>

            

          </div>

        <div class="taglist">
            
    
    
      <a href="/categories/code">code</a> 
      <a href="/tags/draft">draft</a> 
    
    <a href="https://twitter.com/intent/tweet?text=No%20post%20anterior%20sobre%20debug%20eu%20havia%20me%20focado%20mais%20na%20depura%c3%a7%c3%a3o%20de%20processos%20remotos%20no%20Visual%20Studio%202003%20de%20maneira...%20http%3a%2f%2fwww.caloni.com.br%2fforma-mais-simples-de-depurar-processos-antes-do-logon%2f from @caloni " style="text-decoration: underline;" title="Twitter">twitter</big></a>


        </div>

        <div class="navigation-bottom">
            <span style="float: right;"><a href="http://www.caloni.com.br/migrando-imagens-para-imgur/">Migrando Imagens Para Imgur<span class="icon"><i class="fa fa-arrow-right"></i></span></a></span>
<span style="float: left;"><a href="http://www.caloni.com.br/outlander-segunda-temporada/"><span class="icon"><i class="fa fa-arrow-left"></i></span>Outlander - Segunda Temporada</a></span>

        </div>

      </div>

    <footer class="footer">
  <div class="container">
    <span style="float: right;"><i style="font-size: small;">Blogue do Caloni 2020. Copyright é invenção do capitalismo burguês opressor. Todos os direitos não serão reservados.</i></span>
  </div>
</footer>

  </body>

</html>
