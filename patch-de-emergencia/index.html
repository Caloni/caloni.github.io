<!DOCTYPE html>
<html lang="en-us" dir="ltr" itemscope itemtype="http://schema.org/Article">

  
  
      
  
      
  

  <head>
  <meta charset="utf-8" />

  
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Blogue do Caloni - Patch de emergência</title>
  <meta name="author" content="" />

  <meta name="generator" content="Hugo 0.67.1" />

  
  <meta property="og:title" content="Patch de emergência"/>
  <meta property="og:type"
        content="article"/>
  <meta property="og:url" content="http://www.caloni.com.br/patch-de-emergencia/"/>
  <meta property="og:image"
        content="/img/author.jpg"/>
  <meta property="og:description"
        content="Após um projeto muito bem sucedido, entregue no prazo e homologado em tempo recorde, você e sua equipe estão aproveitando suas devidas férias nas Bahamas, tomando água de coco na sombra de uma..."/>

  
  <link href="" rel="feed" type="application/rss+xml"
        title="Blogue do Caloni"/>

  
  
  <link rel="stylesheet" type="text/css" href="/css/custom.css"/>

  
  <script>
  
    
      <!-- Google Analytics -->
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
      ga('create', 'UA-50557403-2', 'auto');
      ga('send', 'pageview');
    
  
  </script>
  <script src="/js/jquery.min.js"></script>
  <script src="/js/list.js"></script>

  
  <link rel="icon" href="/img/favicon.ico"/>
  </head>


  <body style="min-height:100vh;display:flex;flex-direction:column">

    <nav class="navbar has-shadow is-white"
     role="navigation" aria-label="main navigation">

  <div class="container">

    <div class="navbar-brand">
        <img alt="Brand" src="/img/brand.svg">
        &nbsp;
        <a class="navbar-item" title="Go to Home" href="/">
            <div class="is-6">Blogue do Caloni</div>
        </a>
    </div>

    

  </div>
</nav>


      
      <div class="container">
        <p class="title">

Patch de emergência

</p>

        <p class="subtitle">

  Wanderley Caloni,
  
    
  
    
  
  <a href="https://github.com/Caloni/blog/blob/master/content/posts/patch-de-emergencia.md">2010-11-08</a>

</p>

        

        
          <div class="content">

            
              <p>Após um projeto muito bem sucedido, entregue no prazo e homologado em tempo recorde, você e sua equipe estão aproveitando suas devidas férias nas Bahamas, tomando água de coco na sombra de uma palmeira e apreciando a beleza natural da região. Ambas as belezas. =)</p>
<p><img src="http://i.imgur.com/ggKPJuT.jpg" alt="Club-med-beach-governors-harbour-eleuthera-bahamas">]</p>
<p>Mas eis que liga o seu gerente para o celular vermelho que te entregou no caso de emergências críticas e te avisa que um problema crítico foi detectado em um serviço crítico: o detector de pares. Consegue ver o erro?</p>
<p><img src="http://i.imgur.com/wHctVe6.png" alt="Detector de Pares"></p>
<!-- raw HTML omitted -->
<p>Com toda a calma do mundo, você saca o seu netbook, baixa a versão homologada do controle de fonte e descobre facilmente o problema, gerando um patch e recompilando o projeto.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;windows.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdio.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;time.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdlib.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">DoProcess</span>()
{
	<span style="color:#66d9ef">int</span> nextNumber <span style="color:#f92672">=</span> rand() <span style="color:#f92672">%</span> <span style="color:#ae81ff">1000</span>;
	<span style="color:#75715e">//bool even = nextNumber % 2;
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">bool</span> even <span style="color:#f92672">=</span> <span style="color:#f92672">!</span>(nextNumber <span style="color:#f92672">%</span> <span style="color:#ae81ff">2</span>);
	printf(<span style="color:#e6db74">&#34;%d =&gt; %s</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, nextNumber, even <span style="color:#f92672">?</span> <span style="color:#e6db74">&#34;even&#34;</span> <span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;odd&#34;</span>);
}

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>()
{
	srand( time(<span style="color:#ae81ff">0</span>) );

	<span style="color:#66d9ef">while</span>( true )
	{
		DoProcess();
		Sleep(<span style="color:#ae81ff">3000</span>);
	}
}

 

</code></pre></div><p>Feliz da vida, avisa o seu chefe que a única coisa que precisam trocar é o serviço crítico. Parar, trocar o arquivo, reiniciar o serviço. Simples.</p>
<p>Porém, ele lhe avisa que esse é um serviço crítico, que não pode parar por nenhum segundo sequer. A atualização terá que ser feita sem parar o ciclo ininterrupto de pares/ímpares chegando do gerador de números randômicos.</p>
<p>Mais uma vez calmo da vida, você diz que isso é coisa de criança. Tudo que precisa fazer é atualizar a versão certa na memória. O arquivo poderá ser renomeado e, quando o serviço puder ser reiniciado, a versão nova será executada. Enquanto isso, o patch na memória bastará para corrigir o problema e não causar nenhum momento inoperante.</p>
<p>Tudo que você precisa é abrir o processo pelo WinDbg, encontrar a versão defeituosa e substituir os bytes certos.</p>
<p><img src="http://i.imgur.com/zrZQir4.png" alt="Corrigindo versão"></p>
<!-- raw HTML omitted -->
<p>Analisando o disassembly da função nova e antiga podemos perceber que o tamanho delas não mudou (bom sinal), mas o uso dos registradores e a lógica interna teve uma alteração significativa (mau sinal):</p>
<pre><code>Função antiga: bool even = nextNumber % 2;
test    edx,edx
setne   al
mov     byte ptr [ebp-1],al
movzx   ecx,byte ptr [ebp-1]
test    ecx,ecx
je      criticalservice!DoProcess+0x3f (0040105f)

Função nova: bool even = !(nextNumber % 2);
neg     edx
sbb     edx,edx
inc     edx
mov     byte ptr [ebp-1],dl
movzx   eax,byte ptr [ebp-1]
test    eax,eax
je      criticalservice!DoProcess+0x3f (0040105f)
</code></pre>
<p>Podemos começar escrevendo a função nova da memória do processo de teste para um arquivo, e lendo em seguida para cima da função antiga. Só que para isso temos que nos certificar que os endereços que referenciam para fora da função sejam os mesmos. Nesse caso, felizmente, são.</p>
<pre><code>0:001&gt; .writemem c:\tests\newfunc.dat criticalservice!DoProcess 0040107e
Writing 5f bytes.
</code></pre>
<p>Em seguida iremos sobrescrever a função antiga no processo em execução. Para evitar crashes é vital que tenhamos certeza que a função não estará sendo executada nesse momento. No nosso caso basta aguardar a entrada na função Sleep da API, que dorme por 3 segundos, tempo suficiente para a atualização.</p>
<p><img src="http://i.imgur.com/bMI63Ka.png" alt="Live Patch!"></p>
<pre><code>0:000&gt; .readmem c:\tests\newfunc.dat criticalservice!DoProcess 0040107e
Reading 5f bytes.
</code></pre>
<p>Atualizada a função, apenas nos lembramos de renomear o arquivo antigo e atualizar o novo para evitar reativar o problema. Agora podemos voltar para a apreciação das belezas da natureza...</p>

            

          </div>

        <div class="taglist">
            
    
      <a href="/tags/draft">draft</a>  <a href="/tags/code">code</a> 
    <a class="externalgray" href="https://telegram.me/share/url?url=http://www.caloni.com.br/patch-de-emergencia/">discuss</a>


        </div>

        <div class="navigation-bottom">
            <span class="next-in-section"><a href="http://www.caloni.com.br/patch-de-emergencia-2/">&#x25C1; Patch de emergência 2</a></span>
<span class="prev-in-section"><a href="http://www.caloni.com.br/atividade-paranormal-2/">&#x25B7; Atividade Paranormal 2</a></span>

        </div>

      </div>

    <footer class="footer">
  <div class="container">
    <span style="float: right;"><i style="font-size: small;">Blogue do Caloni <a href="https://github.com/Caloni/blog">2021.05.02</a> </i></span>
  </div>
</footer>

  </body>

</html>
