<!DOCTYPE html>
<html lang="en-us" dir="ltr" itemscope itemtype="http://schema.org/Article">

  
  
      
  
      
  

  <head>
  <meta charset="utf-8" />

  
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Blogue do Caloni - Sizeof (de novo)</title>
  <meta name="author" content="" />

  <meta name="generator" content="Hugo 0.67.1" />

  
  <meta property="og:title" content="Sizeof (de novo)"/>
  <meta property="og:type"
        content="article"/>
  <meta property="og:url" content="http://www.caloni.com.br/sizeof-de-novo/"/>
  <meta property="og:image"
        content="/img/author.jpg"/>
  <meta property="og:description"
        content="Algumas coisas em C parecem tão simples na programação do dia-a-dia que em alguns momentos podem existir situações confusas e misteriosas. O uso obscuro do operador sizeof, por exemplo, pode dar..."/>

  
  <link href="" rel="feed" type="application/rss+xml"
        title="Blogue do Caloni"/>

  
  
  <link rel="stylesheet" type="text/css" href="/css/custom.css"/>

  
  <script>
  
    
      <!-- Google Analytics -->
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
      ga('create', 'UA-50557403-2', 'auto');
      ga('send', 'pageview');
    
  
  </script>
  <script src="/js/jquery.min.js"></script>
  <script src="/js/list.js"></script>

  
  <link rel="icon" href="/img/favicon.ico"/>
  </head>


  <body style="min-height:100vh;display:flex;flex-direction:column">

    <nav class="navbar has-shadow is-white"
     role="navigation" aria-label="main navigation">

  <div class="container">

    <div class="navbar-brand">
        <img alt="Brand" src="/img/brand.svg">
        &nbsp;
        <a class="navbar-item" title="Go to Home" href="/">
            <div class="is-6">Blogue do Caloni</div>
        </a>
    </div>

    

  </div>
</nav>


      
      <div class="container">
        <p class="title">

Sizeof (de novo)

</p>

        <p class="subtitle">

  Wanderley Caloni,
  
    
  
    
  
  2007-12-17<a href="https://github.com/Caloni/blog/blob/master/content/posts/sizeof-de-novo.md">.</a>

</p>

        

        
          <div class="content">

            
              <p>Algumas coisas em C parecem tão simples na programação do dia-a-dia que em alguns momentos podem existir situações confusas e misteriosas. O uso obscuro do operador <strong>sizeof</strong>, por exemplo, pode dar margens a interpretações erradas a respeito do que está acontecendo por baixo dos panos. Apesar do padrão ter sido elaborado para tentar tornar a linguagem uma coisa intuitiva e de fácil dedução, isso não acontece todas as vezes.</p>
<p>Vamos tomar, por exemplo, o seguinte minicódigo:</p>
<pre><code>size_t len = sizeof(&quot;A simple string&quot;);
memcpy(buf, &quot;A simple string&quot;, len);
</code></pre>
<p>A pergunta ingênua: <strong>quantos <em>bytes</em> são copiados para buf?</strong></p>
<p>A resposta ingênua: <strong>er... o tamanho de &quot;A simple string&quot;?</strong></p>
<p>Agora vamos supor que você é um pouco mais esperto e começa a pensar: &quot;mas, peraí, estou passando na realidade um ponteiro para sizeof, o que quer dizer que, se meus cálculos estiverem corretos, e estivermos em uma plataforma de 32 bits, sizeof deve retornar 4, o que quer dizer que acabei de achar um <em>bug</em> escabroso, uhuu!&quot;.</p>
<p>Muito bem, o raciocínio é perfeito. Afinal de contas, &quot;A simple string&quot; é um ponteiro para um array de caracteres terminados em zero, certo?</p>
<p>Estou quase certo disso. Porém, isso quer dizer que já deixei vários <em>bugs</em> escabrosos há uns 4 anos atrás em trechos de código parecidos com esse. Será que eu estava errado e não me dei conta, ou sabia de algo que esqueci faz muito tempo?</p>
<h4 id="em-caso-de-dúvida-olhe-o-padrão">Em caso de dúvida, olhe o padrão!</h4>
<p>Eu e meu amigo demos uma olhada no padrão da linguagem C de 89 (revisão de 90), que diz duas coisas muito importantes nesse momento: o que é um sizeof e o que é uma <em>string</em> constante (chamada no padrão de <em>string</em> literal):</p>
<!-- raw HTML omitted -->
<blockquote>
<h4 id="sizeof-6334">Sizeof (6.3.3.4)</h4>
</blockquote>
<p><em>The sizeof operator yields the size (in bytes) of its operand, which may be an expression or the parenthesized name of a type. The size is determined from <strong>the type of the operand</strong>, which is not itself evaluated. The result is an integer constant.</em></p>
<blockquote>
<h4 id="string-literal-614">String literal (6.1.4)</h4>
</blockquote>
<p>_A character string literal is a sequence of zero or more multibyte characters enclosed in double-quotes, as in &quot;xyz&quot;. A wide string literal is the same, except prefixed by the letter L. (...) The multibyte character sequence is then used to initialize an <strong>array of static storage</strong> duration and <strong>lenght just sufficient to contain the sequence</strong>._<!-- raw HTML omitted --></p>
<p>Em C++ (padrão ISO de 98) o texto é muito parecido, apenas abragendo também o conceito de type-id (desnecessário explicar para o contexto deste artigo):</p>
<!-- raw HTML omitted -->
<blockquote>
<h4 id="sizeof-533">Sizeof (5.3.3)</h4>
</blockquote>
<p><em>The sizeof operator yields the number of bytes in the object representation of its operand. The operand is either an expression, which is not evaluated, or a parenthesized <strong>type-id</strong>.</em></p>
<blockquote>
<h4 id="string-literal-2134">String literal (2.13.4)</h4>
</blockquote>
<p>_A string literal is a sequence of characters (as defined in 2.13.2) surrounded by double quotes, optionally beginning with the letter L, as in &quot;...&quot; or L&quot;...&quot;. (...) An ordinary string literal has type &quot;<strong>array of n const char</strong>&quot; and static storage duration (...)._<!-- raw HTML omitted --></p>
<p>Os grifos são meus, para demonstrar que o operador sizeof irá retornar o número de <em>bytes</em> baseado no tipo do operando, e que o tipo de uma <em>string</em> literal é de array de caracteres com o tamanho justo para caber a <em>string</em>.</p>
<p>Bem, todos sabemos o resultado das linhas abaixo:</p>
<pre><code>char charArray[100];
size_t len = sizeof(charArray);
</code></pre>
<p>Nesse caso é simples de observar que o operador sizeof irá retornar 100, que é o número em <em>bytes</em> para abrigar o tipo do operando, que é de &quot;array de 100 caracteres&quot;. Podemos, então, imaginar que a nossa idiomática expressão do início é no fundo um resumo das linhas que se seguem.</p>
<pre><code>...
static char aSimpleString[] = &quot;A simple string&quot;;
...
size_t len = sizeof(aSimpleString);
memcpy(buf, aSimpleString, len); // obs: dependente da implementação
</code></pre>
<p>Ou seja, o tipo de nossa <em>string</em> é na verdade de array estático de caracteres, como se uma variável tivesse sido definida anteriormente com o conteúdo da string, que deve estar em algum lugar da memória do programa. Visto dessa forma fica bem mais simples de entender o que acontece na versão resumida.</p>
<p>O mais encorajador desse problema do sizeof é que a resposta ingênua estava certa, ou seja, pelo menos dessa vez, o padrão conseguiu através de suas regras seguir a intuição do programador.</p>

            

          </div>

        <div class="taglist">
            
    
      <a href="/tags/draft">draft</a>  <a href="/tags/code">code</a> 
    


        </div>

        <div class="navigation-bottom">
            <span class="next-in-section"><a href="http://www.caloni.com.br/drag-and-drop-no-c-builder/">&#x25C1; Drag and drop no C&#43;&#43; Builder</a></span>
<span class="prev-in-section"><a href="http://www.caloni.com.br/debug-remoto-no-c-builder/">&#x25B7; Debug remoto no C&#43;&#43; Builder</a></span>

        </div>

      </div>

    <footer class="footer">
  <div class="container">
    <span style="float: right;"><i style="font-size: small;">Blogue do Caloni 2021<a href="https://github.com/Caloni/blog">.</a> </i></span>
  </div>
</footer>

  </body>

</html>
