<!DOCTYPE html>
<html lang="en-us" dir="ltr" itemscope itemtype="http://schema.org/Article">

  <head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Blogue do Caloni - Aquele do-while engraçado</title>
  <meta name="author" content="" />
  <meta name="description"
        content="Nesses últimos dias andei conversando com um amigo que está estudando sistemas operacionais na faculdade. Melhor ainda, vendo o código real de um sistema operacional em funcionamento. A conseqüência é..."/>

  <meta name="generator" content="Hugo 0.67.1" />

  
  <meta itemprop="name" content="Aquele do-while engraçado"/>
  <meta itemprop="description"
        content="Nesses últimos dias andei conversando com um amigo que está estudando sistemas operacionais na faculdade. Melhor ainda, vendo o código real de um sistema operacional em funcionamento. A conseqüência é..."/>
  <meta itemprop="image"
        content=""/>

  
  <meta property="og:title" content="Aquele do-while engraçado"/>
  <meta property="og:type"
        content="article"/>
  <meta property="og:url" content="http://www.caloni.com.br/aquele-do-while-engracado/"/>
  <meta property="og:image"
        content=""/>
  <meta property="og:description"
        content="Nesses últimos dias andei conversando com um amigo que está estudando sistemas operacionais na faculdade. Melhor ainda, vendo o código real de um sistema operacional em funcionamento. A conseqüência é..."/>
  <meta property="og:site_name" content="Blogue do Caloni"/>
  <meta property="article:published_time"
        content="2008-05-15T00:00:00&#43;00:00"/>
  <meta property="article:section" content="post"/>

  
  
  <meta name="twitter:card" content="summary"/>
  <meta name="twitter:site"
        content=""/>
  <meta name="twitter:title" content="Aquele do-while engraçado"/>
  <meta name="twitter:description"
        content="Nesses últimos dias andei conversando com um amigo que está estudando sistemas operacionais na faculdade. Melhor ainda, vendo o código real de um sistema operacional em funcionamento. A conseqüência é..."/>
  <meta name="twitter:creator"
        content=""/>
  <meta name="twitter:image:src"
        content="
                     /images/movies.png
                   "/>

  
  <link href="" rel="alternate" type="application/rss+xml"
        title="Blogue do Caloni"/>
  <link href="" rel="feed" type="application/rss+xml"
        title="Blogue do Caloni"/>

  
  <link rel="stylesheet" type="text/css" href="/css/capsule.min.css"/>
  
  <link rel="stylesheet" type="text/css" href="/css/custom.css"/>

  
  <script>
  
    
      <!-- Google Analytics -->
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
      ga('create', 'UA-50557403-2', 'auto');
      ga('send', 'pageview');
    
  
  </script>
  <script src="/js/jquery.min.js"></script>
  <script src="/js/list.js"></script>

  
  <link rel="icon" href="/favicon.ico"/>
  </head>


  <body style="min-height:100vh;display:flex;flex-direction:column">

    <nav class="navbar has-shadow is-white"
     role="navigation" aria-label="main navigation">
  <div class="container">

    <div class="navbar-brand">
      <a class="navbar-item" title="Go to Home" href="/">
        <img alt="Brand" src="/brand.svg">
        <div class="title is-6">&nbsp;Blogue do Caloni</div>
      </a>

      
      <label class="button navbar-burger is-white" for="navbar-burger-state">
        <span></span>                               
        <span></span>
        <span></span>
      </label>
    </div>

    
    <input type="checkbox" id="navbar-burger-state"/>

    <div class="navbar-menu">
      <div class="navbar-end" style="padding: 10px;">
      <big><b>
       <a title="posts dessa categoria" href="/categories/blog">blog</a>  <a title="posts dessa categoria" href="/categories/cinema">cinema</a>  <a title="posts dessa categoria" href="/categories/code">code</a> 
       <a href="/caloni"><span class="icon"><i class="fa fa-user"></i></a> <a href="index.xml"><span class="icon"><i class="fa fa-rss"></i></a>
      </big></b>
      </div>
    </div>

  </div>
</nav>


      
      <div class="container">
        <p class="title">Aquele do-while engraçado</p>

        <p class="subtitle">
<i>

    <a href="https://github.com/Caloni/post/commits/master/aquele-do-while-engracado.md" title="History">
    2008-05-15
    </a>

<span class="icon"><i class="fa fa-clock-o"></span></i>4 </i>
 <span class="icon"><i class="fa fa-pencil"></i></span><a href="https://github.com/Caloni/post/blob/master/aquele-do-while-engracado.md" title="GitHub">682</a>
</p>

        <div class="taglist">
            <i>Este ainda é um rascunho publicado prematuramente e está sujeito a mudanças substanciais.</i>

        </div>

        

        
          <div class="content">
            
              <p>Nesses últimos dias andei conversando com um amigo que está estudando sistemas operacionais na faculdade. Melhor ainda, vendo o código real de um sistema operacional em funcionamento. A conseqüência é que, além de aprender um bocado de como as coisas funcionam de verdade debaixo dos panos, acaba-se aprendendo alguns truquezinhos básicos e tradicionais da linguagem C.</p>
<p>Por exemplo, é um hábito conhecido o uso de construções do-while quando existe a necessidade de definir uma macro que possui mais de um comando em vez de usar a igualmente conhecida { construção de múltiplos comandos entre chaves }.</p>
<p>O que talvez não seja tão conhecido é o porquê das coisas serem assim.</p>
<p>Vamos imaginar uma macro de logue que é habilitada em compilações debug, mas é mantida em silêncio em compilações release:</p>
<pre><code>#ifdef NDEBUG

#define MYTRACE( message ) /* nothing */

#else

#define MYTRACE( message )        \
    {                              \
        char buffer[500];           \
        sprintf(buffer,             \
            &quot;MYTRACE: %s(%d) %s\n&quot;,  \
            __FILE__,                \
            __LINE__,                \
            message);                \
        OutputDebugString(buffer);  \
    }

#endif /* NDEBUG */ 
</code></pre>
<p>Nada de mais, e parece até funcionar. Porém, como veremos nas próximas linhas, esse é realmente um exemplo de código &ldquo;buguento&rdquo;, já que uma chamada dentro de uma construção if-else simplesmente não funciona.</p>
<pre><code>if( exploded() )
    MYTRACE(&quot;Oh, my God&quot;);
else
    MYTRACE(&quot;That's right&quot;); 



error C2181: illegal else without matching if
</code></pre>
<p>Por que isso? Para responder a essa questão nós precisamos olhar um pouco mais de perto no resultado do preprocessador da linguagem, que apenas troca nossa macro pelo pedaço de código que ela representa:</p>
<pre><code>if( exploded() )
    {
        char buffer[500];
        sprintf(buffer,
            &quot;MYTRACE: %s(%d) %s\n&quot;,
            __FILE__,
            __LINE__,
            &quot;Oh, my God&quot;);
        OutputDebugString(buffer);
    };
else
    {
        char buffer[500];
        sprintf(buffer,
            &quot;MYTRACE: %s(%d) %s\n&quot;,
            __FILE__,
            __LINE__,
            &quot;That's right&quot;);
        OutputDebugString(buffer);
    };
</code></pre>
<p>Dessa forma, podemos ver o porquê. Quando chamamos a macro, geralmente usamos a sintaxe de chamada de função, colocando um sinal de ponto-e-vírgula logo após a chamada. Essa é a maneira correta de se chamar uma função, mas no caso de uma macro, dessa macro, é um desastre, porque ela cria dois comandos em vez de um só (um ponto-e-vírgula vazio, apesar de não fazer nada, é um comando válido). Então, isso é o que o compilador faz:</p>
<pre><code>if( instruction )
{
    /* um monte de comandos */

} /* aqui eu esperaria um else ou uma instrução nova */
</code></pre>
<p>; /* uma instrução nova! ok, sem else desa vez */</p>
<pre><code>else /* espere ae! o que esse else está fazendo aqui sem um if?!?! */
{
    /* mais comandos */
}
</code></pre>
<p>Pense sobre o comando vazio como se ele fosse um comando real, o que é a maneira mais fácil de entender o erro de compilação que recebemos ao compilar o código abaixo:</p>
<pre><code>if( error() )
{
    printf(&quot;error&quot;);
}
</code></pre>
<p>printf(&ldquo;here we go&rdquo;);</p>
<pre><code>else /* llegal else without matching if! */
{
    printf(&quot;okay&quot;);
}
</code></pre>
<p>Por essa razão, a maneira tradicional de escapar desse erro comum é usar uma construção válida que peça de fato um ponto-e-vírgula no final. Felizmente nós, programadores C/C++, temos essa construção, e ela é&hellip; muito bem, o do-while!</p>
<pre><code>do
{
    /* múltiplos comandos aqui */
}
while( expression )
</code></pre>
<p>;</p>
<pre><code> /* eu espero um ponto-e-vírgula aqui, para
                         finalizar minha instrução do-while */
</code></pre>
<p>Assim nós podemos reescrever nossa macro de logue da maneira certa (e todas as 549.797 macros já escritas em nossa vida de programador). E, apesar de ser uma construção um tanto bizarra, ela funciona melhor do que nossa tentativa inicial:</p>
<pre><code>#ifdef NDEBUG

#define MYTRACE( message ) /* nothing */

#else

#define MYTRACE( message )        \
    do                             \
    {                              \
        char buffer[500];           \
        sprintf(buffer,             \
            &quot;MYTRACE: %s(%d) %s\n&quot;,  \
            __FILE__,                \
            __LINE__,                \
            message);                \
        printf(buffer);             \
    }                              \
    while( 0 )

#endif /* NDEBUG */ 
</code></pre>
<p>Ao usar um do-while (com uma expressão que retorna falso dentro do teste, de maneira que o código seja executado apenas uma vez) a construção if-else consegue funcionar perfeitamente:</p>
<pre><code>if( exploded() )
    do
    {
        char buffer[500];
        sprintf(buffer,
            &quot;MYTRACE: %s(%d) %s\n&quot;,
            __FILE__,
            __LINE__,
            &quot;Oh, my God&quot;);
        OutputDebugString(buffer);
    }
    while( 0 );
else
    do
    {
        char buffer[500];
        sprintf(buffer,
            &quot;MYTRACE: %s(%d) %s\n&quot;,
            __FILE__,
            __LINE__,
            &quot;That's right&quot;);
        OutputDebugString(buffer);
    }
    while( 0 );
</code></pre>

            

          </div>

        <div class="taglist">
            
    
      <a href="/categories/code">code</a> 
      <a href="/tags/draft">draft</a> 
    
    <a href="https://twitter.com/intent/tweet?text=Nesses%20%c3%baltimos%20dias%20andei%20conversando%20com%20um%20amigo%20que%20est%c3%a1%20estudando%20sistemas%20operacionais%20na%20faculdade.%20Melhor%20ainda%2c...%20http%3a%2f%2fwww.caloni.com.br%2faquele-do-while-engracado%2f from @caloni " style="text-decoration: underline;" title="Twitter">twitter</big></a>


        </div>

        <div class="navigation-bottom">
            <span style="float: right;"><a href="http://www.caloni.com.br/busca-do-google-com-atalhos/">Busca do Google com atalhos<span class="icon"><i class="fa fa-arrow-right"></i></span></a></span>
<span style="float: left;"><a href="http://www.caloni.com.br/kernel-mode-user-mode/"><span class="icon"><i class="fa fa-arrow-left"></i></span>Kernel Mode &gt;&gt; User Mode</a></span>

        </div>

      </div>

    <footer class="footer">
  <div class="container">
    <span style="float: right;"><i style="font-size: small;">Blogue do Caloni 2020. Copyright é invenção do capitalismo burguês opressor. Todos os direitos não serão reservados.</i></span>
  </div>
</footer>

  </body>

</html>
