<!DOCTYPE html>
<html lang="en-us" dir="ltr" itemscope itemtype="http://schema.org/Article">

  
  
      
  
      
  

  <head>
  <meta charset="utf-8" />

  
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Blogue do Caloni - Compartilhando variáveis com o mundo</title>
  <meta name="author" content="" />

  <meta name="generator" content="Hugo 0.67.1" />

  
  <meta property="og:title" content="Compartilhando variáveis com o mundo"/>
  <meta property="og:type"
        content="article"/>
  <meta property="og:url" content="http://www.caloni.com.br/compartilhando-variaveis-com-o-mundo/"/>
  <meta property="og:image"
        content="/img/author.jpg"/>
  <meta property="og:description"
        content="Desde que comecei a programar, para compartilhar variáveis entre processo é meio que consenso usar-se a milenar técnica do crie uma seção compartilhada no seu executável/DLL. Isso funciona desde a..."/>

  
  <link href="" rel="feed" type="application/rss+xml"
        title="Blogue do Caloni"/>

  
  
  <link rel="stylesheet" type="text/css" href="/css/custom.css"/>

  
  <script>
  
    
      <!-- Google Analytics -->
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
      ga('create', 'UA-50557403-2', 'auto');
      ga('send', 'pageview');
    
  
  </script>
  <script src="/js/jquery.min.js"></script>
  <script src="/js/list.js"></script>

  
  <link rel="icon" href="/img/favicon.ico"/>
  </head>


  <body style="min-height:100vh;display:flex;flex-direction:column">

    <nav class="navbar has-shadow is-white"
     role="navigation" aria-label="main navigation">

  <div class="container">

    <div class="navbar-brand">
        <img alt="Brand" src="/img/brand.svg">
        &nbsp;
        <a class="navbar-item" title="Go to Home" href="/">
            <div class="is-6">Blogue do Caloni</div>
        </a>
    </div>

    

  </div>
</nav>


      
      <div class="container">
        <p class="title">

Compartilhando variáveis com o mundo

</p>

        <p class="subtitle">

  Wanderley Caloni,
  
    
  
    
  
  2008-01-30<a href="https://github.com/Caloni/blog/blob/master/content/posts/compartilhando-variaveis-com-o-mundo.md">.</a>

</p>

        

        
          <div class="content">

            
              <p>Desde que comecei a programar, para compartilhar variáveis entre processo é meio que consenso usar-se a milenar técnica do <strong>crie uma seção compartilhada no seu executável/DLL</strong>. Isso funciona desde a época em que o Windows era <a href="http://dqsoft.blogspot.com/2006/10/gerenciamento-de-memria-windows-16-bits.html">em preto e branco</a>. Mas, como tudo em programação, existem mil maneiras de assar o pato. Esse artigo explica uma delas, a não-tão-milenar técnica do <strong>use memória mapeada nomeada misturada com templates.</strong></p>
<h4 id="antigamente">Antigamente...</h4>
<p>Era comum (talvez ainda seja) fazer um código assim:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#75715e">// aqui definimos uma nova seção (note o &#39;shared&#39; usado como atributo)
</span><span style="color:#75715e"></span><span style="color:#75715e">#pragma section(&#34;shared&#34;, read, write, shared)
</span><span style="color:#75715e"></span>
<span style="color:#75715e">// um conjunto de variáveis agrupadas para facilitar o compartilhamento
</span><span style="color:#75715e"></span><span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">EstruturaDoCoracao</span>
{
	<span style="color:#66d9ef">int</span> meuIntPreferido;
	<span style="color:#66d9ef">char</span> meuCharAmigo;
	<span style="color:#66d9ef">double</span> meuNumeroDePontoFlutuanteCamarada;
};

<span style="color:#75715e">// uma instância da struct acima para podermos usar nos processo amigos
</span><span style="color:#75715e"></span><span style="color:#66d9ef">__declspec</span>(allocate(<span style="color:#e6db74">&#34;shared&#34;</span>)) EstruturaDoCoracao g_coracao;

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>()
{
	g_coracao.meuCharAmigo <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;C&#39;</span>;
	g_coracao.meuIntPreferido <span style="color:#f92672">=</span> <span style="color:#ae81ff">42</span>;
	g_coracao.meuNumeroDePontoFlutuanteCamarada <span style="color:#f92672">=</span> <span style="color:#ae81ff">3.14159265358979323846264338</span>;
} 

</code></pre></div><p>Aquele pragma do começo garante que qualquer instância do mesmo executável, mas processos distintos, irão compartilhar qualquer variável definida dentro da seção &quot;shared&quot;. O nome na verdade não importa muito - é apenas usado para clareza - , mas o <strong>atributo do final</strong>, sim.</p>
<p>Algumas desvantagens dessa técnica são:</p>
<ul>
<li>
<p>Não permite compartilhamento entre executáveis diferentes, salvo se tratar-se de uma DLL carregada por ambos.</p>
</li>
<li>
<p>É um compartilhamento estático, que permanece do início do primeiro processo ao fim do último.</p>
</li>
<li>
<p>Não possui proteção, ou seja, se for uma DLL, qualquer executável que a carregar tem acesso à área de memória.</p>
</li>
</ul>
<p>Muitas vezes essa abordagem é suficiente, como em <a href="http://msdn.microsoft.com/library/en-us/winui/winui/windowsuserinterface/windowing/hooks/hookreference/hookfunctions/setwindowshookex.asp">_hooks _globais</a>, que precisam apenas de uma ou duas variáveis compartilhadas. Também pode ser útil como contador de instâncias, do mesmo jeito que usamos as <strong>variáveis estáticas de uma classe em C++</strong> (vide <a href="http://www.boost.org/libs/smart_ptr/shared_ptr.htm">shared_ptr</a> do boost, ou a CString do ATL, que usa o mesmo princípio).</p>
<h4 id="memória-mapeada-compartilhada-nomeada">Memória mapeADA compartilhADA nomeADA</h4>
<p>Houve uma vez em que tive que fazer <em>hooks</em> direcionados a threads específicas no sistema, onde eu não sabia nem qual o processo <em>host</em> nem quantos _hooks _seriam feitos. Essa é uma situação onde fica <strong>muito difícil</strong> usar a técnica milenar.</p>
<p>Foi daí que eu fiz um conjunto de funções alfa-beta de compartilhamento de variáveis baseado em template e memória mapeada:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#75715e">#pragma once
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;windows.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;tchar.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">/** Aloca uma variável em memória mapeada, permitindo a qualquer processo
</span><span style="color:#75715e">com direitos enxergá-la e alterá-la.
</span><span style="color:#75715e">*/</span>

<span style="color:#66d9ef">template</span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">typename</span> T<span style="color:#f92672">&gt;</span>
HANDLE AllocSharedVariable(T<span style="color:#f92672">**</span> pVar, PCTSTR varName)
{
	DWORD varSize <span style="color:#f92672">=</span> <span style="color:#66d9ef">sizeof</span>(T);
	HANDLE ret <span style="color:#f92672">=</span> CreateFileMapping(INVALID_HANDLE_VALUE, NULL, PAGE_READWRITE,
		<span style="color:#ae81ff">0</span>, varSize, varName);

	<span style="color:#66d9ef">if</span>( ret )
	{
		<span style="color:#f92672">*</span>pVar <span style="color:#f92672">=</span> (T<span style="color:#f92672">*</span>) MapViewOfFile(ret, FILE_MAP_ALL_ACCESS, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>);

		<span style="color:#66d9ef">if</span>( <span style="color:#f92672">!</span> <span style="color:#f92672">*</span>pVar )
		{
			DWORD err <span style="color:#f92672">=</span> GetLastError();
			CloseHandle(ret);
			SetLastError(err);
		}
	}
	<span style="color:#66d9ef">else</span>
		<span style="color:#f92672">*</span>pVar <span style="color:#f92672">=</span> NULL;

	<span style="color:#66d9ef">return</span> ret;
}

<span style="color:#75715e">/** Abre uma variável que foi criada em memória mapeada, permitindo ao
</span><span style="color:#75715e">processo atual enxergar e alterar uma variável criada por outro processo.
</span><span style="color:#75715e">*/</span>
<span style="color:#66d9ef">template</span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">typename</span> T<span style="color:#f92672">&gt;</span>
HANDLE OpenSharedVariable(T<span style="color:#f92672">**</span> pVar, PCTSTR varName)
{
	DWORD varSize <span style="color:#f92672">=</span> <span style="color:#66d9ef">sizeof</span>(T);
	HANDLE ret <span style="color:#f92672">=</span> OpenFileMapping(FILE_MAP_ALL_ACCESS, FALSE, varName);

	<span style="color:#66d9ef">if</span>( ret )
	{
		<span style="color:#f92672">*</span>pVar <span style="color:#f92672">=</span> (T<span style="color:#f92672">*</span>) MapViewOfFile(ret, FILE_MAP_READ <span style="color:#f92672">|</span> FILE_MAP_WRITE, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, varSize);

		<span style="color:#66d9ef">if</span>( <span style="color:#f92672">!</span> <span style="color:#f92672">*</span>pVar )
		{
		DWORD err <span style="color:#f92672">=</span> GetLastError();
		CloseHandle(ret);
		ret <span style="color:#f92672">=</span> NULL;
		SetLastError(err);
		}
	}
	<span style="color:#66d9ef">else</span>
		<span style="color:#f92672">*</span>pVar <span style="color:#f92672">=</span> NULL;

	<span style="color:#66d9ef">return</span> ret;
}

<span style="color:#75715e">/** Libera visualização de uma variável em memória mapeada. Quando o último processo
</span><span style="color:#75715e">liberar a última visualização, a variável é eliminada da memória.
</span><span style="color:#75715e">*/</span>
<span style="color:#66d9ef">template</span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">typename</span> T<span style="color:#f92672">&gt;</span>
VOID FreeSharedVariable(HANDLE varH, T<span style="color:#f92672">*</span> pVar)
{
	<span style="color:#66d9ef">if</span>( pVar )
		UnmapViewOfFile(pVar);
	<span style="color:#66d9ef">if</span>( varH )
		CloseHandle(varH);
} 

</code></pre></div><p>Como pode-se ver, o seu funcionamento é muito simples: uma função-template que recebe uma referência para um ponteiro de ponteiro do tipo da variável desejada, o seu nome global e retorna uma <strong>variável alocada na memória de cachê do sistema</strong>. Como contraparte existe uma função que abre essa memória baseada em seu nome e faz o <em>cast</em> (coversão de tipo) necessário. Ambas as chamadas devem chamar uma terceira função para liberar o recurso.</p>
<p>O segredo para entender mais detalhes dessa técnica é <strong>pesquisar as funções envolvidas</strong>: CreateFileMapping, OpenFileMapping, MapViewOfFile e UnmapViewOfFile. Bem, o CloseHandle também ;)</p>
<h4 id="que-tal-um-exemplo">Que tal um exemplo?</h4>
<p>Ah, é mesmo! Fiz especialmente para o artigo:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#75715e">#define _CRT_SECURE_NO_DEPRECATE
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&#34;ShareVar.h&#34;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;windows.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;tchar.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdio.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#define SHARED_VAR &#34;FraseSecreta&#34;
</span><span style="color:#75715e"></span>
<span style="color:#75715e">/** Exemplo de como usar as funções de alocação de memória compartilhada
</span><span style="color:#75715e">AllocSharedVariable, OpenSharedVariable e FreeSharedVariable.
</span><span style="color:#75715e">*/</span>
<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">_tmain</span>(<span style="color:#66d9ef">int</span> argc, PTSTR argv[])
{
	<span style="color:#75715e">// passou algum parâmetro: lê a variável compartilhada e exibe
</span><span style="color:#75715e"></span>
	<span style="color:#66d9ef">if</span>( argc <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">1</span> )
	{
		system(<span style="color:#e6db74">&#34;pause&#34;</span>);

		TCHAR (<span style="color:#f92672">*</span>sharedVar)[<span style="color:#ae81ff">100</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; <span style="color:#75715e">// ponteiro para array de 100 TCHARs
</span><span style="color:#75715e"></span>		HANDLE varH <span style="color:#f92672">=</span> AllocSharedVariable(<span style="color:#f92672">&amp;</span>sharedVar, _T(SHARED_VAR));

		<span style="color:#66d9ef">if</span>( varH <span style="color:#f92672">&amp;&amp;</span> sharedVar )
		{
			_tprintf(_T(<span style="color:#e6db74">&#34;Frase secreta: &#39;%s&#39;n&#34;</span>), <span style="color:#f92672">*</span>sharedVar);
			_tprintf(_T(<span style="color:#e6db74">&#34;Pressione &lt;enter&gt; para retornar...&#34;</span>));
			getchar();
		}
	}
	<span style="color:#66d9ef">else</span> <span style="color:#75715e">// não passou parâmetro: escreve na variável 
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// compartilhada e chama nova instância
</span><span style="color:#75715e"></span>	{
		TCHAR (<span style="color:#f92672">*</span>sharedVar)[<span style="color:#ae81ff">100</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; <span style="color:#75715e">// ponteiro para array de 100 TCHARs
</span><span style="color:#75715e"></span>		HANDLE varH <span style="color:#f92672">=</span> AllocSharedVariable(<span style="color:#f92672">&amp;</span>sharedVar, _T(SHARED_VAR));

		<span style="color:#66d9ef">if</span>( varH <span style="color:#f92672">&amp;&amp;</span> sharedVar )
		{
			PTSTR cmd <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> TCHAR[ _tcslen(argv[<span style="color:#ae81ff">0</span>]) <span style="color:#f92672">+</span> <span style="color:#ae81ff">10</span> ];
			_tcscpy(cmd, _T(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">&#34;</span>));
			_tcscat(cmd, argv[<span style="color:#ae81ff">0</span>]);
			_tcscat(cmd, _T(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74"> 2&#34;</span>));

			_tcscpy(<span style="color:#f92672">*</span>sharedVar, _T(<span style="color:#e6db74">&#34;Tuintuintuclaim&#34;</span>));
			_tsystem(cmd);

			<span style="color:#66d9ef">delete</span> [] cmd;
		}
	}

	<span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
} 

</code></pre></div><h4 id="_disclaimer_-ou-não-tenho-nada-a-ver-com-isso"><em>Disclaimer</em> (ou &quot;não-tenho-nada-a-ver-com-isso&quot;)</h4>
<p>Preciso lembrar que essa é uma versão inicial ainda, mas que pode muito bem ser melhorada. Duas idéias interessantes são: parametrizar a proteção da variável (através do <strong>SECURITY_ATTRIBUTES</strong>) e transformá-la em classe. Uma classe parece ser uma idéia bem popular. Afinal, tem tanta gente que só se consegue programar se o código estiver dentro de uma.</p>
<h4 id="para-saber-mais">Para saber mais</h4>
<ul>
<li>
<p><a href="http://msdn.microsoft.com/">MSDN Library</a> - by Microsoft</p>
</li>
<li>
<p><a href="http://www.codeproject.com/">Code Project</a> - by Developers</p>
</li>
<li>
<p><a href="http://www.google.com/">Google</a> - by Google</p>
</li>
</ul>

            

          </div>

        <div class="taglist">
            
    
      <a href="/tags/draft">draft</a>  <a href="/tags/code">code</a> 
    <a class="externalgray" href="https://telegram.me/share/url?url=http://www.caloni.com.br/compartilhando-variaveis-com-o-mundo/">discuss</a>


        </div>

        <div class="navigation-bottom">
            <span class="next-in-section"><a href="http://www.caloni.com.br/compartilhando-variaveis-com-o-mundo-v2/">&#x25C1; Compartilhando variáveis com o mundo v2</a></span>
<span class="prev-in-section"><a href="http://www.caloni.com.br/rmthread-rode-codigo-em-processo-vizinho/">&#x25B7; RmThread: rode código em processo vizinho</a></span>

        </div>

      </div>

    <footer class="footer">
  <div class="container">
    <span style="float: right;"><i style="font-size: small;">Blogue do Caloni 2021<a href="https://github.com/Caloni/blog">.</a> </i></span>
  </div>
</footer>

  </body>

</html>
