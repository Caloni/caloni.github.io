<!DOCTYPE html>
<html lang="en-us" dir="ltr" itemscope itemtype="http://schema.org/Article">

  <head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Blogue do Caloni - Aprenda a usar sua API</title>
  <meta name="author" content="" />
  <meta name="description"
        content="É conhecido que uma das desvantagens de se programar diretamente em Win32 API é a dificuldade de se entender os parâmetros e o retorno das funções. Concordo em parte. Constituída de boa documentação,..."/>

  <meta name="generator" content="Hugo 0.67.1" />

  
  <meta itemprop="name" content="Aprenda a usar sua API"/>
  <meta itemprop="description"
        content="É conhecido que uma das desvantagens de se programar diretamente em Win32 API é a dificuldade de se entender os parâmetros e o retorno das funções. Concordo em parte. Constituída de boa documentação,..."/>
  <meta itemprop="image"
        content=""/>

  
  <meta property="og:title" content="Aprenda a usar sua API"/>
  <meta property="og:type"
        content="article"/>
  <meta property="og:url" content="http://www.caloni.com.br/aprenda-a-usar-sua-api/"/>
  <meta property="og:image"
        content=""/>
  <meta property="og:description"
        content="É conhecido que uma das desvantagens de se programar diretamente em Win32 API é a dificuldade de se entender os parâmetros e o retorno das funções. Concordo em parte. Constituída de boa documentação,..."/>
  <meta property="og:site_name" content="Blogue do Caloni"/>
  <meta property="article:published_time"
        content="2008-07-22T00:00:00&#43;00:00"/>
  <meta property="article:section" content="post"/>

  
  
  <meta name="twitter:card" content="summary"/>
  <meta name="twitter:site"
        content=""/>
  <meta name="twitter:title" content="Aprenda a usar sua API"/>
  <meta name="twitter:description"
        content="É conhecido que uma das desvantagens de se programar diretamente em Win32 API é a dificuldade de se entender os parâmetros e o retorno das funções. Concordo em parte. Constituída de boa documentação,..."/>
  <meta name="twitter:creator"
        content=""/>
  <meta name="twitter:image:src"
        content="
                     /images/movies.png
                   "/>

  
  <link href="" rel="alternate" type="application/rss+xml"
        title="Blogue do Caloni"/>
  <link href="" rel="feed" type="application/rss+xml"
        title="Blogue do Caloni"/>

  
  <link rel="stylesheet" type="text/css" href="/css/capsule.min.css"/>
  
  <link rel="stylesheet" type="text/css" href="/css/custom.css"/>

  
  <script>
  
    
      <!-- Google Analytics -->
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
      ga('create', 'UA-50557403-2', 'auto');
      ga('send', 'pageview');
    
  
  </script>
  <script src="/js/jquery.min.js"></script>
  <script src="/js/list.js"></script>

  
  <link rel="icon" href="/favicon.ico"/>
  </head>


  <body style="min-height:100vh;display:flex;flex-direction:column">

    <nav class="navbar has-shadow is-white"
     role="navigation" aria-label="main navigation">
  <div class="container">

    <div class="navbar-brand">
      <a class="navbar-item" title="Go to Home" href="/">
        <img alt="Brand" src="/brand.svg">
        <div class="title is-6">&nbsp;Blogue do Caloni</div>
      </a>

      
      <label class="button navbar-burger is-white" for="navbar-burger-state">
        <span></span>                               
        <span></span>
        <span></span>
      </label>
    </div>

    
    <input type="checkbox" id="navbar-burger-state"/>

    <div class="navbar-menu">
      <div class="navbar-end" style="padding: 10px;">
      <big><b>
       <a title="posts dessa categoria" href="/categories/blog">blog</a>  <a title="posts dessa categoria" href="/categories/cinema">cinema</a>  <a title="posts dessa categoria" href="/categories/code">code</a> 
       <a href="/caloni"><span class="icon"><i class="fa fa-user"></i></a> <a href="index.xml"><span class="icon"><i class="fa fa-rss"></i></a>
      </big></b>
      </div>
    </div>

  </div>
</nav>


      
      <div class="container">
        <p class="title">Aprenda a usar sua API</p>

        <p class="subtitle">
<i>

    <a href="https://github.com/Caloni/post/commits/master/aprenda-a-usar-sua-api.md" title="History">
    2008-07-22
    </a>

<span class="icon"><i class="fa fa-clock-o"></span></i>3 </i>
 <span class="icon"><i class="fa fa-pencil"></i></span><a href="https://github.com/Caloni/post/blob/master/aprenda-a-usar-sua-api.md" title="GitHub">591</a>
</p>

        <div class="taglist">
            <i>Este ainda é um rascunho publicado prematuramente e está sujeito a mudanças substanciais.</i>

        </div>

        

        
          <div class="content">
            
              <p>É conhecido que uma das desvantagens de se programar diretamente em Win32 API é a dificuldade de se entender os parâmetros e o retorno das funções. Concordo em parte. Constituída de boa documentação, parte da culpa dos programas mal-feitos reside na preguiça do programador em olhar a documentação por completo.</p>
<p>A Win32 API está longe de ser perfeita, mas pelo menos está razoavelmente documentada, e é na leitura atenta da documentação que iremos encontrar as respostas que precisamos para que o programa funcione.</p>
<p>Vejamos alguns exemplos.</p>
<p>O código abaixo parece bem razoável:</p>
<pre><code>#include &lt;windows.h&gt;

int main()
{
    HANDLE hFile = CreateFile(&quot;c:\\tests\\myfile.txt&quot;, GENERIC_READ, 
        FILE_SHARE_READ, NULL, OPEN_EXISTING, 0, NULL);

    if( hFile )
    {
        DWORD read = 0;
        CHAR buffer[100];

        if( ReadFile(hFile, buffer, sizeof(buffer), &amp;read, NULL) )
        {
            WriteBuffer(buffer);
        }

        CloseHandle(hFile);
    }
}
</code></pre>
<p>No entanto, está errado.</p>
<p>É fato que a maioria das funções que retornam handles retornam NULL para indicar o erro na tentativa de obter o recurso. Ao comparar o retorno com NULL, o programador geralmente faz uma chamada a GetLastError.aspx) para saber o que aconteceu. No entanto, uma das funções mais usadas, a CreateFile, não retorna NULL, mas INVALIDHANDLEVALUE.</p>
<p>Sendo assim, o código acima deveria ser:</p>
<pre><code>if( hFile != INVALID_HANDLE_VALUE )
</code></pre>
<p>Taí uma função que muitos erraram. Erraram tanto que eles fizeram uma nova versão menos complicada. Como está escrito no MSDN.aspx):</p>
<p>&ldquo;The GetVersionEx function was developed because many existing applications err when examining the packed DWORD value returned by GetVersion, transposing the major and minor version numbers.&rdquo;</p>
<p>O motivo de tantos erro pode ter sido o fato que o valor retornado é uma estrutura de bits dentro de um DWORD, coisa que nem todos programadores C sabem lidar muito bem, e o fato de ser uma função muito utilizada por todos (pegar a versão do sistema operacional).</p>
<p>Eis a tabela de campos do retorno de GetVersion:</p>
<pre><code>Platform                                High-order bit   Next 7 bits     Low-order byte
-------------------------------------   --------------   ------------    --------------
Windows NT 3.51                         0                Build number    3
Windows NT 4.0                          0                Build number    4
Windows 2000 or Windows XP              0                Build number    5
Windows 95, Windows 98, or Windows Me   1                Reserved        4
Win32s with Windows 3.1                 1                Build number    3
</code></pre>
<p>Mesmo que não seja tão difícil, pode ser ambíguo. Por exemplo, como saber se o Windows é 95, 98 ou ME?</p>
<p>O código abaixo, muito usado por todos que suportam ainda o Windows mais velhinhos, verifica se estamos rodando em plataforma NT ou 9x.</p>
<pre><code>#include &lt;windows.h&gt;
#include &lt;stdio.h&gt;

int main()
{
    DWORD winVer = GetVersion();
    BOOL isPlatformNT = winVer &gt;= 0x80000000 ? FALSE : TRUE;

    if( isPlatformNT )
        printf(&quot;Plataforma NT\n&quot;);
    else
        printf(&quot;Bem-vindo ao parque dos dinossauros!\n&quot;);

    return isPlatformNT ? 1 : 0;
}
</code></pre>
<p>Nem sempre o handle que obtemos é fechado com CloseHandle. As funções abaixo retornam handles que devem ser desalocados com as funções à direita:</p>
<pre><code>Função que obtém recurso         Função que libera recurso
------------------------         -------------------------
LoadLibrary                      FreeLibrary
RegOpenKey                       RegCloseKey
GetDC                            ReleaseDC
BeginPaint                       EndPaint
</code></pre>
<p>Sempre tem. Algumas dicas úteis para o dia-a-dia de um programador Win32 API são:</p>
<ul>
<li>
<p>Leia a documentação</p>
</li>
<li>
<p>Se atente aos valores de retorno em caso de sucesso e erro</p>
</li>
<li>
<p>Leia sempre a seção remarks pelo menos uma vez; ela explica como desalocar recursos</p>
</li>
<li>
<p>Releia a documentação</p>
</li>
</ul>
<p>Às vezes uma singela chamada de uma função de autenticação pode nos fazer preencher uma estrutura de 20 membros, sendo que seis deles são obtidos com mais sete chamadas de funções, todas com direito a desalocar recursos no final. O importante é sempre manter a calma, o espírito de aprendizado e aventura. Afinal, quem mandou não fazer software de telinha?</p>

            

          </div>

        <div class="taglist">
            
    
      <a href="/categories/code">code</a> 
      <a href="/tags/draft">draft</a> 
    
    <a href="https://twitter.com/intent/tweet?text=%c3%89%20conhecido%20que%20uma%20das%20desvantagens%20de%20se%20programar%20diretamente%20em%20Win32%20API%20%c3%a9%20a%20dificuldade%20de%20se%20entender%20os...%20http%3a%2f%2fwww.caloni.com.br%2faprenda-a-usar-sua-api%2f from @caloni " style="text-decoration: underline;" title="Twitter">twitter</big></a>


        </div>

        <div class="navigation-bottom">
            <span style="float: right;"><a href="http://www.caloni.com.br/entrevista-com-o-caloni-no-do-zero-ao-mestre/">Entrevista com o Caloni no &#39;Do ZERO ao MESTRE&#39;<span class="icon"><i class="fa fa-arrow-right"></i></span></a></span>
<span style="float: left;"><a href="http://www.caloni.com.br/o-conhecido-unresolved-external/"><span class="icon"><i class="fa fa-arrow-left"></i></span>O conhecido unresolved external</a></span>

        </div>

      </div>

    <footer class="footer">
  <div class="container">
    <span style="float: right;"><i style="font-size: small;">Blogue do Caloni 2020. Copyright é invenção do capitalismo burguês opressor. Todos os direitos não serão reservados.</i></span>
  </div>
</footer>

  </body>

</html>
