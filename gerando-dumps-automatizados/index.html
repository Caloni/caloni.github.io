<!DOCTYPE html>
<html lang="en-us" dir="ltr" itemscope itemtype="http://schema.org/Article">

  <head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Blogue do Caloni - Gerando dumps automatizados</title>
  <meta name="author" content="" />
  <meta name="description"
        content="Agora que a temporada das telas azuis passou estou às voltas com o nosso sistema de detecção de crashes, além de alguns dumps e logs pra relaxar de vez em quando.
Fiquei impressionado com a..."/>

  <meta name="generator" content="Hugo 0.67.1" />

  
  <meta itemprop="name" content="Gerando dumps automatizados"/>
  <meta itemprop="description"
        content="Agora que a temporada das telas azuis passou estou às voltas com o nosso sistema de detecção de crashes, além de alguns dumps e logs pra relaxar de vez em quando.
Fiquei impressionado com a..."/>
  <meta itemprop="image"
        content=""/>

  
  <meta property="og:title" content="Gerando dumps automatizados"/>
  <meta property="og:type"
        content="article"/>
  <meta property="og:url" content="http://www.caloni.com.br/gerando-dumps-automatizados/"/>
  <meta property="og:image"
        content=""/>
  <meta property="og:description"
        content="Agora que a temporada das telas azuis passou estou às voltas com o nosso sistema de detecção de crashes, além de alguns dumps e logs pra relaxar de vez em quando.
Fiquei impressionado com a..."/>
  <meta property="og:site_name" content="Blogue do Caloni"/>
  <meta property="article:published_time"
        content="2010-08-26T00:00:00&#43;00:00"/>
  <meta property="article:section" content="post"/>

  
  
  <meta name="twitter:card" content="summary"/>
  <meta name="twitter:site"
        content=""/>
  <meta name="twitter:title" content="Gerando dumps automatizados"/>
  <meta name="twitter:description"
        content="Agora que a temporada das telas azuis passou estou às voltas com o nosso sistema de detecção de crashes, além de alguns dumps e logs pra relaxar de vez em quando.
Fiquei impressionado com a..."/>
  <meta name="twitter:creator"
        content=""/>
  <meta name="twitter:image:src"
        content="
                     /images/movies.png
                   "/>

  
  <link href="" rel="alternate" type="application/rss+xml"
        title="Blogue do Caloni"/>
  <link href="" rel="feed" type="application/rss+xml"
        title="Blogue do Caloni"/>

  
  <link rel="stylesheet" type="text/css" href="/css/capsule.min.css"/>
  
  <link rel="stylesheet" type="text/css" href="/css/custom.css"/>

  
  <script>
  
    
      <!-- Google Analytics -->
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
      ga('create', 'UA-50557403-2', 'auto');
      ga('send', 'pageview');
    
  
  </script>
  <script src="/js/jquery.min.js"></script>
  <script src="/js/list.js"></script>

  
  <link rel="icon" href="/favicon.ico"/>
  </head>


  <body style="min-height:100vh;display:flex;flex-direction:column">

    <nav class="navbar has-shadow is-white"
     role="navigation" aria-label="main navigation">
  <div class="container">

    <div class="navbar-brand">
      <a class="navbar-item" title="Go to Home" href="/">
        <img alt="Brand" src="/brand.svg">
        <div class="title is-6">&nbsp;Blogue do Caloni</div>
      </a>

      
      <label class="button navbar-burger is-white" for="navbar-burger-state">
        <span></span>                               
        <span></span>
        <span></span>
      </label>
    </div>

    
    <input type="checkbox" id="navbar-burger-state"/>

    <div class="navbar-menu">
      <div class="navbar-end" style="padding: 10px;">
      <big><b>
       <a title="posts dessa categoria" href="/categories/blog">blog</a>  <a title="posts dessa categoria" href="/categories/cinema">cinema</a>  <a title="posts dessa categoria" href="/categories/code">code</a> 
       <a href="/caloni"><span class="icon"><i class="fa fa-user"></i></a> <a href="index.xml"><span class="icon"><i class="fa fa-rss"></i></a>
      </big></b>
      </div>
    </div>

  </div>
</nav>


      
      <div class="container">
        <p class="title">Gerando dumps automatizados</p>

        <p class="subtitle">
<i>

    <a href="https://github.com/Caloni/post/commits/master/gerando-dumps-automatizados.md" title="History">
    2010-08-26
    </a>

<span class="icon"><i class="fa fa-clock-o"></span></i>2 </i>
 <span class="icon"><i class="fa fa-pencil"></i></span><a href="https://github.com/Caloni/post/blob/master/gerando-dumps-automatizados.md" title="GitHub">287</a>
</p>

        <div class="taglist">
            <i>Este ainda é um rascunho publicado prematuramente e está sujeito a mudanças substanciais.</i>

        </div>

        

        
          <div class="content">
            
              <p>Agora que a temporada das telas azuis passou estou às voltas com o nosso sistema de detecção de crashes, além de alguns dumps e logs pra relaxar de vez em quando.</p>
<p>Fiquei impressionado com a simplicidade com que podemos capturar qualquer exceção que ocorra em um programa, independente da thread, e gravar um minidump com o contexto exato em que o problema ocorreu. O uso da função API SetUnhandledExceptionFilter aliado com a já citada na palestra MiniDumpWriteDump pode agilizar muito a correção de crashes triviais como Access Violation.</p>
<p>A mágica é tão bela que resolvi gravar um vídeo do que ocorreu quando compilei e testei o programa abaixo. Note que o tamanho do arquivo de dump ficou em torno dos 10 KB, ridículos nessa era de barateamento de espaço.</p>
<pre><code>/** @file OnCrash

@brief Exemplo de como capturar exceções no seu programa.

@author Wanderley Caloni &lt;wanderley@caloni.com.br&gt;
@date 2010-08
*/
#include &lt;windows.h&gt;
#include &lt;dbghelp.h&gt;
#include &lt;time.h&gt;

#pragma comment(lib, &quot;dbghelp.lib&quot;)

LONG WINAPI CrashHandler(_EXCEPTION_POINTERS* ExceptionInfo)
{
    LONG ret = EXCEPTION_CONTINUE_SEARCH;
    MINIDUMP_EXCEPTION_INFORMATION minidumpInfo;

    minidumpInfo.ClientPointers = FALSE;
    minidumpInfo.ThreadId = GetCurrentThreadId();
    minidumpInfo.ExceptionPointers = ExceptionInfo;

    HANDLE hFile = CreateFile(&quot;OnCrash.dmp&quot;, GENERIC_WRITE, 0, NULL, CREATE_ALWAYS, 0, NULL);

    if( hFile != INVALID_HANDLE_VALUE )
    {
        MINIDUMP_TYPE dumpType = MiniDumpNormal;

        if( MiniDumpWriteDump(GetCurrentProcess(), GetCurrentProcessId(), 
            hFile, MiniDumpNormal, &amp;minidumpInfo, NULL, NULL) )
        {
            ret = EXCEPTION_EXECUTE_HANDLER;
        }

        CloseHandle(hFile);
    }

    return ret;
}

DWORD WINAPI CrashThread(PVOID)
{
    int* x = 0;
    *x = 13;
    return 0;
}

int main()
{
    SetUnhandledExceptionFilter(CrashHandler);
    HANDLE crashThread = CreateThread(NULL, 0, CrashThread, NULL, 0, NULL);
    WaitForSingleObject(crashThread, INFINITE);
}
</code></pre>
<p>Espero com isso aliviar a carga pesada de A.V.s que sempre aparece quando menos se espera. Cuidar de toneladas de código legado exige algumas pitadas de automatização nos lugares certos. Como já dizia meu primeiro chefe: se a mente não pensa&hellip;</p>

            

          </div>

        <div class="taglist">
            
    
      <a href="/categories/code">code</a> 
      <a href="/tags/draft">draft</a> 
    
    <a href="https://twitter.com/intent/tweet?text=Agora%20que%20a%20temporada%20das%20telas%20azuis%20passou%20estou%20%c3%a0s%20voltas%20com%20o%20nosso%20sistema%20de%20detec%c3%a7%c3%a3o%20de%20crashes%2c%20al%c3%a9m%20de%20alguns...%20http%3a%2f%2fwww.caloni.com.br%2fgerando-dumps-automatizados%2f from @caloni " style="text-decoration: underline;" title="Twitter">twitter</big></a>


        </div>

        <div class="navigation-bottom">
            <span style="float: right;"><a href="http://www.caloni.com.br/um-lugar-chamado-notting-hill/">Um Lugar Chamado Notting Hill<span class="icon"><i class="fa fa-arrow-right"></i></span></a></span>
<span style="float: left;"><a href="http://www.caloni.com.br/o-ultimo-mestre-do-ar/"><span class="icon"><i class="fa fa-arrow-left"></i></span>O Último Mestre do Ar</a></span>

        </div>

      </div>

    <footer class="footer">
  <div class="container">
    <span style="float: right;"><i style="font-size: small;">Blogue do Caloni 2020. Copyright é invenção do capitalismo burguês opressor. Todos os direitos não serão reservados.</i></span>
  </div>
</footer>

  </body>

</html>
