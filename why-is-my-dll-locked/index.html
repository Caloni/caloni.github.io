<!DOCTYPE html>
<html lang="en-us" dir="ltr" itemscope itemtype="http://schema.org/Article">

  
  
      
  
      
  

  <head>
  <meta charset="utf-8" />

  
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Blogue do Caloni - Why is my DLL locked?</title>
  <meta name="author" content="" />

  <meta name="generator" content="Hugo 0.67.1" />

  
  <meta property="og:title" content="Why is my DLL locked?"/>
  <meta property="og:type"
        content="article"/>
  <meta property="og:url" content="http://www.caloni.com.br/why-is-my-dll-locked/"/>
  <meta property="og:image"
        content="/img/author.jpg"/>
  <meta property="og:description"
        content="There is a document from Microsoft alerting about the hazards in putting your code inside a DllMain function. what is more comprehensive and easier to read than the MSDN observations. It is worth..."/>

  
  <link href="" rel="feed" type="application/rss+xml"
        title="Blogue do Caloni"/>

  
  
  <link rel="stylesheet" type="text/css" href="/css/custom.css"/>

  
  <script>
  
    
      <!-- Google Analytics -->
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
      ga('create', 'UA-50557403-2', 'auto');
      ga('send', 'pageview');
    
  
  </script>
  <script src="/js/jquery.min.js"></script>
  <script src="/js/list.js"></script>

  
  <link rel="icon" href="/img/favicon.ico"/>
  </head>


  <body style="min-height:100vh;display:flex;flex-direction:column">

    <nav class="navbar has-shadow is-white"
     role="navigation" aria-label="main navigation">

  <div class="container">

    <div class="navbar-brand">
        <img alt="Brand" src="/img/brand.svg">
        &nbsp;
        <a class="navbar-item" title="Go to Home" href="/">
            <div class="is-6">Blogue do Caloni</div>
        </a>
    </div>

    

  </div>
</nav>


      
      <div class="container">
        <p class="title">

Why is my DLL locked?

</p>

        <p class="subtitle">

  Wanderley Caloni,
  
    
  
    
  
  2007-09-24<a href="https://github.com/Caloni/blog/blob/master/content/posts/why-is-my-dll-locked.md">.</a>

</p>

        

        
          <div class="content">

            
              <p>There is a <a href="http://www.microsoft.com/whdc/driver/kernel/DLL_bestprac.mspx">document</a> from Microsoft alerting about the hazards in putting your code inside a DllMain function. what is more comprehensive and easier to read than the <a href="http://msdn.microsoft.com/library/en-us/dllproc/base/dllmain.asp">MSDN observations</a>. It is worth reading, even because the explanations about the loader lock and its side effects can do very good for your code health.</p>
<h4 id="the-concept">The concept</h4>
<p>In short, the Windows code responsible to call DllMain for each loaded/unloaded DLLs uses an exclusive access object (the so-called &quot;mutex&quot;) to synchronize its calls. The result is that inside a process just one DllMain can be called at a given moment. This object-mutex is called &quot;loader lock&quot; into the Microsoft documentation.</p>
<p><a href="/images/loaderlock.gif"><img src="http://i.imgur.com/mjJ0Xmm.gif" alt="Loader Lock explained"></a></p>
<h4 id="the-code">The code</h4>
<p>The code below is silly, but represents quite well what I've seen in lots of production code. For many times I was unable to realize what was going on (whether because I didn't know about the loader lock or the code readability was too bad). The comments say by themselves:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#75715e">//
</span><span style="color:#75715e">// LoaderLock.dll
</span><span style="color:#75715e">//
</span><span style="color:#75715e"></span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;windows.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
HANDLE g_thrLock <span style="color:#f92672">=</span> NULL; <span style="color:#75715e">// locked thread handle
</span><span style="color:#75715e"></span>BOOL g_getOut <span style="color:#f92672">=</span> FALSE; <span style="color:#75715e">// it would be useful to unlock the thread, but it&#39;s not
</span><span style="color:#75715e"></span>
<span style="color:#75715e">/** The thread locker
</span><span style="color:#75715e">
</span><span style="color:#75715e">The function of this thread is to lock. It tries to call DllMain (indirectly). 
</span><span style="color:#75715e">In order to do this, it needs the loader lock. Unfortunately the main thread 
</span><span style="color:#75715e">has got it before. The obvious result: this secondary thread is going to 
</span><span style="color:#75715e">wait forever for a resource that will be never released.
</span><span style="color:#75715e">*/</span>
DWORD WINAPI <span style="color:#a6e22e">ThreadLock</span>(PVOID)
{
	<span style="color:#66d9ef">while</span>( true )
	{
		<span style="color:#75715e">// I&#39;m here to hinder, not to help
</span><span style="color:#75715e"></span>		Sleep(<span style="color:#ae81ff">1000</span>);
		<span style="color:#66d9ef">if</span>( g_getOut ) 
			<span style="color:#66d9ef">break</span>;
	}

	<span style="color:#66d9ef">return</span> ERROR_ACCESS_DENIED; <span style="color:#75715e">// this does not work
</span><span style="color:#75715e"></span>}

<span style="color:#75715e">/** The DllMain locker
</span><span style="color:#75715e">
</span><span style="color:#75715e">The function of this DllMain is to show how not to code an DllMain. It creates 
</span><span style="color:#75715e">a thread on the PROCESS_ATTACH event (bad sign). Not happy yet, it waits 
</span><span style="color:#75715e">for the thread on the PROCESS_DETACH event (bad bad sign). As this thead has 
</span><span style="color:#75715e">got the loader lock, the secondary thread will never reach the point 
</span><span style="color:#75715e">where it returns.
</span><span style="color:#75715e">*/</span>
BOOL WINAPI <span style="color:#a6e22e">DllMain</span>(HINSTANCE hinstDLL, DWORD fdwReason, LPVOID lpvReserved)
{
	<span style="color:#66d9ef">if</span>( fdwReason <span style="color:#f92672">==</span> DLL_PROCESS_ATTACH )
	{
		<span style="color:#75715e">// creates the locked thread
</span><span style="color:#75715e"></span>		DWORD tid <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
		g_thrLock <span style="color:#f92672">=</span> CreateThread(NULL, <span style="color:#ae81ff">0</span>, ThreadLock, NULL, <span style="color:#ae81ff">0</span>, <span style="color:#f92672">&amp;</span>tid);
	}
	<span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span>( fdwReason <span style="color:#f92672">==</span> DLL_PROCESS_DETACH )
	{
		<span style="color:#75715e">// waits for the thread for ever and ever
</span><span style="color:#75715e"></span>		g_getOut <span style="color:#f92672">=</span> TRUE;
		WaitForSingleObject(g_thrLock, INFINITE);
		CloseHandle(g_thrLock), g_thrLock <span style="color:#f92672">=</span> NULL;
	}
} 

</code></pre></div><p>A simple victim of all this can be an executable using a poorly written DLL, just like the code above:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#75715e">//
</span><span style="color:#75715e">// Victim.exe
</span><span style="color:#75715e">//
</span><span style="color:#75715e"></span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;windows.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;tchar.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>()
{
	HMODULE lockDll <span style="color:#f92672">=</span> LoadLibrary(_T(<span style="color:#e6db74">&#34;LoaderLock.dll&#34;</span>));

	<span style="color:#66d9ef">if</span>( lockDll )
	{
		Sleep(<span style="color:#ae81ff">5000</span>);
		FreeLibrary(lockDll), lockDll  <span style="color:#f92672">=</span> NULL;
	}
} 

</code></pre></div><p>In order to the see the locking code in action, download the <a href="/images/loaderlock.cpp">DLL</a> and <a href="/images/loaderlock-exe.cpp">EXE</a> source files and use the following commands to generate the executable files:</p>
<pre><code>cl /c loaderlock.cpp loaderlock-exe.cpp
link loaderlock-exe.obj
link /dll loaderlock.obj
</code></pre>
<h4 id="nothing-is-perfect">Nothing is perfect</h4>
<p>It is important to remember that a DllMain dependant code is a very, very bad thing. Nevertheless, there are some particular cases the only place to run our code is inside DllMain. In these cases, when detected, try to run a side by side communication with your locked thread using an event object (or equivalent) before it really returns. Using this craft the thread can warn the waiting thread that the important thing to be done is done, and the waiting thread can go to sleep and stop waiting forever locked threads.</p>
<h4 id="more-information">More information</h4>
<ol>
<li>
<p><a href="http://www.microsoft.com/msj/0999/hood/hood0999.aspx">NT Loader (MSJ Sep 99)</a> - Matt Pietrek</p>
</li>
<li>
<p><a href="http://blogs.msdn.com/mgrier/default.aspx">mgrier's WebLog</a> - NT Loader team participant</p>
</li>
</ol>

            

          </div>

        <div class="taglist">
            
    
      <a href="/tags/draft">draft</a>  <a href="/tags/code">code</a> 
    


        </div>

        <div class="navigation-bottom">
            <span class="next-in-section"><a href="http://www.caloni.com.br/introducao-ao-c-builderturbo-c/">&#x25C1; Introdução ao C&#43;&#43; Builder...Turbo C&#43;&#43;</a></span>
<span class="prev-in-section"><a href="http://www.caloni.com.br/a-mobilidade-das-variaveis-no-printf/">&#x25B7; A mobilidade das variáveis no printf</a></span>

        </div>

      </div>

    <footer class="footer">
  <div class="container">
    <span style="float: right;"><i style="font-size: small;">Blogue do Caloni 2021<a href="https://github.com/Caloni/blog">.</a> </i></span>
  </div>
</footer>

  </body>

</html>
