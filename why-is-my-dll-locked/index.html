<!DOCTYPE html>
<html lang="en-us" dir="ltr" itemscope itemtype="http://schema.org/Article">

  <head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Blogue do Caloni - Why is my DLL locked?</title>
  <meta name="author" content="" />
  <meta name="description"
        content="There is a document from Microsoft alerting about the hazards in putting your code inside a DllMain function. what is more comprehensive and easier to read than the MSDN observations. It is worth..."/>

  <meta name="generator" content="Hugo 0.67.1" />

  
  <meta itemprop="name" content="Why is my DLL locked?"/>
  <meta itemprop="description"
        content="There is a document from Microsoft alerting about the hazards in putting your code inside a DllMain function. what is more comprehensive and easier to read than the MSDN observations. It is worth..."/>
  <meta itemprop="image"
        content=""/>

  
  <meta property="og:title" content="Why is my DLL locked?"/>
  <meta property="og:type"
        content="article"/>
  <meta property="og:url" content="http://www.caloni.com.br/why-is-my-dll-locked/"/>
  <meta property="og:image"
        content=""/>
  <meta property="og:description"
        content="There is a document from Microsoft alerting about the hazards in putting your code inside a DllMain function. what is more comprehensive and easier to read than the MSDN observations. It is worth..."/>
  <meta property="og:site_name" content="Blogue do Caloni"/>
  <meta property="article:published_time"
        content="2007-09-24T00:00:00&#43;00:00"/>
  <meta property="article:section" content="post"/>

  
  
  <meta name="twitter:card" content="summary"/>
  <meta name="twitter:site"
        content=""/>
  <meta name="twitter:title" content="Why is my DLL locked?"/>
  <meta name="twitter:description"
        content="There is a document from Microsoft alerting about the hazards in putting your code inside a DllMain function. what is more comprehensive and easier to read than the MSDN observations. It is worth..."/>
  <meta name="twitter:creator"
        content=""/>
  <meta name="twitter:image:src"
        content="
                     /images/movies.png
                   "/>

  
  <link href="" rel="alternate" type="application/rss+xml"
        title="Blogue do Caloni"/>
  <link href="" rel="feed" type="application/rss+xml"
        title="Blogue do Caloni"/>

  
  <link rel="stylesheet" type="text/css" href="/css/capsule.min.css"/>
  
  <link rel="stylesheet" type="text/css" href="/css/custom.css"/>

  
  <script>
  
    
      <!-- Google Analytics -->
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
      ga('create', 'UA-50557403-2', 'auto');
      ga('send', 'pageview');
    
  
  </script>
  <script src="/js/jquery.min.js"></script>
  <script src="/js/list.js"></script>

  
  <link rel="icon" href="/favicon.ico"/>
  </head>


  <body style="min-height:100vh;display:flex;flex-direction:column">

    <nav class="navbar has-shadow is-white"
     role="navigation" aria-label="main navigation">
  <div class="container">

    <div class="navbar-brand">
      <a class="navbar-item" title="Go to Home" href="/">
        <img alt="Brand" src="/brand.svg">
        <div class="title is-6">&nbsp;Blogue do Caloni</div>
      </a>

      
      <label class="button navbar-burger is-white" for="navbar-burger-state">
        <span></span>                               
        <span></span>
        <span></span>
      </label>
    </div>

    
    <input type="checkbox" id="navbar-burger-state"/>

    <div class="navbar-menu">
      <div class="navbar-end" style="padding: 10px;">
      <big><b>
       <a title="posts dessa categoria" href="/categories/blog">blog</a>  <a title="posts dessa categoria" href="/categories/cinema">cinema</a>  <a title="posts dessa categoria" href="/categories/code">code</a> 
      </big></b>
      </div>
    </div>

  </div>
</nav>


      
      <div class="container">
        <p class="title">Why is my DLL locked?</p>

        <p class="subtitle">

    <a href="https://github.com/Caloni/blog/blob/master/content/post/why-is-my-dll-locked.md" title="source">
    2007-09-24
    </a>

</p>

        <div class="taglist">
            <i>Este ainda é um rascunho publicado prematuramente e está sujeito a mudanças substanciais.</i>

        </div>

        

        
          <div class="content">
            
              <p>There is a document from Microsoft alerting about the hazards in putting your code inside a DllMain function. what is more comprehensive and easier to read than the MSDN observations. It is worth reading, even because the explanations about the loader lock and its side effects can do very good for your code health.</p>
<p>In short, the Windows code responsible to call DllMain for each loaded/unloaded DLLs uses an exclusive access object (the so-called &ldquo;mutex&rdquo;) to synchronize its calls. The result is that inside a process just one DllMain can be called at a given moment. This object-mutex is called &ldquo;loader lock&rdquo; into the Microsoft documentation.</p>
<p>The code below is silly, but represents quite well what I&rsquo;ve seen in lots of production code. For many times I was unable to realize what was going on (whether because I didn&rsquo;t know about the loader lock or the code readability was too bad). The comments say by themselves:</p>
<pre><code>//
// LoaderLock.dll
//
#include &lt;windows.h&gt;

HANDLE g_thrLock = NULL; // locked thread handle
BOOL g_getOut = FALSE; // it would be useful to unlock the thread, but it's not

/** The thread locker

The function of this thread is to lock. It tries to call DllMain (indirectly). 
In order to do this, it needs the loader lock. Unfortunately the main thread 
has got it before. The obvious result: this secondary thread is going to 
wait forever for a resource that will be never released.
*/
DWORD WINAPI ThreadLock(PVOID)
{
    while( true )
    {
        // I'm here to hinder, not to help
        Sleep(1000);
        if( g_getOut ) 
            break;
    }

    return ERROR_ACCESS_DENIED; // this does not work
}

/** The DllMain locker

The function of this DllMain is to show how not to code an DllMain. It creates 
a thread on the PROCESS_ATTACH event (bad sign). Not happy yet, it waits 
for the thread on the PROCESS_DETACH event (bad bad sign). As this thead has 
got the loader lock, the secondary thread will never reach the point 
where it returns.
*/
BOOL WINAPI DllMain(HINSTANCE hinstDLL, DWORD fdwReason, LPVOID lpvReserved)
{
    if( fdwReason == DLL_PROCESS_ATTACH )
    {
        // creates the locked thread
        DWORD tid = 0;
        g_thrLock = CreateThread(NULL, 0, ThreadLock, NULL, 0, &amp;tid);
    }
    else if( fdwReason == DLL_PROCESS_DETACH )
    {
        // waits for the thread for ever and ever
        g_getOut = TRUE;
        WaitForSingleObject(g_thrLock, INFINITE);
        CloseHandle(g_thrLock), g_thrLock = NULL;
    }
} 
</code></pre>
<p>A simple victim of all this can be an executable using a poorly written DLL, just like the code above:</p>
<pre><code>//
// Victim.exe
//
#include &lt;windows.h&gt;
#include &lt;tchar.h&gt;

int main()
{
    HMODULE lockDll = LoadLibrary(_T(&quot;LoaderLock.dll&quot;));

    if( lockDll )
    {
        Sleep(5000);
        FreeLibrary(lockDll), lockDll  = NULL;
    }
} 
</code></pre>
<p>In order to the see the locking code in action, copy the DLL and EXE source files and use the following commands to generate the executable files:</p>
<pre><code>cl /c loaderlock.cpp loaderlock-exe.cpp
link loaderlock-exe.obj
link /dll loaderlock.obj
</code></pre>
<p>It is important to remember that a DllMain dependant code is a very, very bad thing. Nevertheless, there are some particular cases the only place to run our code is inside DllMain. In these cases, when detected, try to run a side by side communication with your locked thread using an event object (or equivalent) before it really returns. Using this craft the thread can warn the waiting thread that the important thing to be done is done, and the waiting thread can go to sleep and stop waiting forever locked threads.</p>
<ol>
<li>NT Loader (MSJ Sep 99) - Matt Pietrek</li>
<li>mgrier&rsquo;s WebLog - NT Loader team participant</li>
</ol>

            

          </div>

        <div class="taglist">
            
    
      [<a href="/categories/code">code</a>] 
      [<a href="/tags/draft">draft</a>] 
    
    <a href="https://twitter.com/intent/tweet?text=There%20is%20a%20document%20from%20Microsoft%20alerting%20about%20the%20hazards%20in%20putting%20your%20code%20inside%20a%20DllMain%20function.%20what%20is...%20http%3a%2f%2fwww.caloni.com.br%2fwhy-is-my-dll-locked%2f from @caloni " style="text-decoration: underline;" title="Twitter">twitter</big></a>


        </div>

        <div class="navigation-bottom">
            <span style="float: right;"><a href="http://www.caloni.com.br/introducao-ao-c-builderturbo-c/">Introdução ao C&#43;&#43; Builder...Turbo C&#43;&#43;<span class="icon"><i class="fa fa-arrow-right"></i></span></a></span>
<span style="float: left;"><a href="http://www.caloni.com.br/a-mobilidade-das-variaveis-no-printf/"><span class="icon"><i class="fa fa-arrow-left"></i></span>A mobilidade das variáveis no printf</a></span>

        </div>

      </div>

    <footer class="footer">
  <div class="container">
    <span style="float: right;"><i style="font-size: small;">Blogue do Caloni 2020. Copyright é invenção do capitalismo burguês opressor. Todos os direitos não serão reservados.</i></span>
  </div>
</footer>

  </body>

</html>
