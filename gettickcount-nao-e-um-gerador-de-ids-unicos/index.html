<!DOCTYPE html>
<html lang="en-us" dir="ltr" itemscope itemtype="http://schema.org/Article">

  <head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Blogue do Caloni - GetTickCount não é um gerador de IDs únicos</title>
  <meta name="author" content="" />
  <meta name="description"
        content="Muitas vezes uma solução intuitiva não é exatamente o que esperamos que seja quando o código está rodando. Gerar IDs únicos, por exemplo. Se você analisar por 5 minutos pode chegar à conclusão que um..."/>

  <meta name="generator" content="Hugo 0.67.1" />

  
  <meta itemprop="name" content="GetTickCount não é um gerador de IDs únicos"/>
  <meta itemprop="description"
        content="Muitas vezes uma solução intuitiva não é exatamente o que esperamos que seja quando o código está rodando. Gerar IDs únicos, por exemplo. Se você analisar por 5 minutos pode chegar à conclusão que um..."/>
  <meta itemprop="image"
        content=""/>

  
  <meta property="og:title" content="GetTickCount não é um gerador de IDs únicos"/>
  <meta property="og:type"
        content="article"/>
  <meta property="og:url" content="http://www.caloni.com.br/gettickcount-nao-e-um-gerador-de-ids-unicos/"/>
  <meta property="og:image"
        content=""/>
  <meta property="og:description"
        content="Muitas vezes uma solução intuitiva não é exatamente o que esperamos que seja quando o código está rodando. Gerar IDs únicos, por exemplo. Se você analisar por 5 minutos pode chegar à conclusão que um..."/>
  <meta property="og:site_name" content="Blogue do Caloni"/>
  <meta property="article:published_time"
        content="2012-06-25T00:00:00&#43;00:00"/>
  <meta property="article:section" content="post"/>

  
  
  <meta name="twitter:card" content="summary"/>
  <meta name="twitter:site"
        content=""/>
  <meta name="twitter:title" content="GetTickCount não é um gerador de IDs únicos"/>
  <meta name="twitter:description"
        content="Muitas vezes uma solução intuitiva não é exatamente o que esperamos que seja quando o código está rodando. Gerar IDs únicos, por exemplo. Se você analisar por 5 minutos pode chegar à conclusão que um..."/>
  <meta name="twitter:creator"
        content=""/>
  <meta name="twitter:image:src"
        content="
                     /images/movies.png
                   "/>

  
  <link href="" rel="alternate" type="application/rss+xml"
        title="Blogue do Caloni"/>
  <link href="" rel="feed" type="application/rss+xml"
        title="Blogue do Caloni"/>

  
  <link rel="stylesheet" type="text/css" href="/css/capsule.min.css"/>
  
  <link rel="stylesheet" type="text/css" href="/css/custom.css"/>

  
  <script>
  
    
      <!-- Google Analytics -->
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
      ga('create', 'UA-50557403-2', 'auto');
      ga('send', 'pageview');
    
  
  </script>
  <script src="/js/jquery.min.js"></script>
  <script src="/js/list.js"></script>

  
  <link rel="icon" href="/favicon.ico"/>
  </head>


  <body style="min-height:100vh;display:flex;flex-direction:column">

    <nav class="navbar has-shadow is-white"
     role="navigation" aria-label="main navigation">
  <div class="container">

    <div class="navbar-brand">
      <a class="navbar-item" title="Go to Home" href="/">
        <img alt="Brand" src="/brand.svg">
        <div class="title is-6">&nbsp;Blogue do Caloni</div>
      </a>

      
      <label class="button navbar-burger is-white" for="navbar-burger-state">
        <span></span>                               
        <span></span>
        <span></span>
      </label>
    </div>

    
    <input type="checkbox" id="navbar-burger-state"/>

    <div class="navbar-menu">
      <div class="navbar-end" style="padding: 10px;">
      <big><b>
       <a title="posts dessa categoria" href="/categories/blog">blog</a>  <a title="posts dessa categoria" href="/categories/cinema">cinema</a>  <a title="posts dessa categoria" href="/categories/code">code</a> 
       <a href="/caloni"><span class="icon"><i class="fa fa-user"></i></a> <a href="index.xml"><span class="icon"><i class="fa fa-rss"></i></a>
      </big></b>
      </div>
    </div>

  </div>
</nav>


      
      <div class="container">
        <p class="title">GetTickCount não é um gerador de IDs únicos</p>

        <p class="subtitle">
<i>

    <a href="https://github.com/Caloni/post/commits/master/gettickcount-nao-e-um-gerador-de-ids-unicos.md" title="History">
    2012-06-25
    </a>

<span class="icon"><i class="fa fa-clock-o"></span></i>2 </i>
 <span class="icon"><i class="fa fa-pencil"></i></span><a href="https://github.com/Caloni/post/blob/master/gettickcount-nao-e-um-gerador-de-ids-unicos.md" title="GitHub">410</a>
</p>

        <div class="taglist">
            <i>Este ainda é um rascunho publicado prematuramente e está sujeito a mudanças substanciais.</i>

        </div>

        

        
          <div class="content">
            
              <p>Muitas vezes uma solução intuitiva não é exatamente o que esperamos que seja quando o código está rodando. Gerar IDs únicos, por exemplo. Se você analisar por 5 minutos pode chegar à conclusão que um simples GetTickCount, que tem resolução de clock boa e que se repete apenas depois de 50 dias pode ser um ótimo facilitador para gerar IDs exclusivos durante o dia.</p>
<p>Porém, nada como código para provar que estamos errados:</p>
<pre><code>#include &lt;windows.h&gt;
#include &lt;iostream&gt;
#include &lt;list&gt;
#include &lt;algorithm&gt;
#include &lt;stdlib.h&gt;
#include &lt;time.h&gt;

using namespace std;

list&lt;DWORD&gt; g_ticks;
list&lt;LONG&gt; g_increments;

DWORD WINAPI Ticks(PVOID)
{
    for( int i = 1; i &lt;= 100; ++i )
    {
        DWORD tick = GetTickCount();
        g_ticks.push_back(tick);
        Sleep(rand() % 20);
    }
    return 0;
}

DWORD WINAPI Increment(PVOID)
{
    static LONG st_prevIncrement = 0;

    for( int i = 1; i &lt;= 100; ++i )
    {
        LONG increment = InterlockedIncrement(&amp;st_prevIncrement);
        g_increments.push_back(increment);
        Sleep(rand() % 20);
    }
    return 0;
}

int main()
{
    const size_t threadsCount = 20;
    HANDLE threads[threadsCount];

    srand((unsigned int) time(0));

    for( size_t i = 0; i &lt; threadsCount / 2; ++i )
        threads[i] = CreateThread(NULL, 0, Ticks, NULL, 0, NULL);
    for( size_t i = threadsCount / 2; i &lt; threadsCount; ++i )
        threads[i] = CreateThread(NULL, 0, Increment, NULL, 0, NULL);

    WaitForMultipleObjects(threadsCount, threads, TRUE, INFINITE);

    for( auto it = g_ticks.begin(); it != g_ticks.end(); ++it )
    {
        DWORD tick = *it;
        size_t tickOccurrence = count(g_ticks.begin(), g_ticks.end(), tick);

        if( tickOccurrence &gt; 1 )
        {
            cout &lt;&lt; &quot;Ocorrencia de tick duplicado!\n&quot;;
            break;
        }
    }

    for( auto it = g_increments.begin(); it != g_increments.end(); ++it )
    {
        DWORD tick = *it;
        size_t incrementOccurrence = count(g_increments.begin(), g_increments.end(), tick);

        if( incrementOccurrence &gt; 1 )
        {
            cout &lt;&lt; &quot;Ocorrencia de incremento duplicado!\n&quot;;
            break;
        }
    }
}
</code></pre>
<p>O motivo do GetTickCount retornar números iguais remete tanto ao fato que o espaço de tempo entre uma execução e outra pode ser muito pequeno quanto ao fato de várias threads podem ser executadas efetivamente ao mesmo tempo em ambientes de dois ou mais cores.</p>
<p>Já o motivo do InterlockedIncrement funcionar sempre é porque aqui estamos usando uma solução de incremento atômico, ou seja, usamos a mesma base contadora e incrementamos ela em uma operação que não pode ocorrer ao mesmo tempo com outra thread.</p>
<p>O que aprendemos aqui? Que por mais que seja intuitiva uma solução, nunca podemos nos basear nas nossas falhas cabeças. Um computador está aí não apenas para ser mais rápido, mas para ser assertivo em nossas elucubrações. Nesse sentido, é o nosso companheiro vulcaniano.</p>

            

          </div>

        <div class="taglist">
            
    
      <a href="/categories/code">code</a> 
      <a href="/tags/draft">draft</a> 
    
    <a href="https://twitter.com/intent/tweet?text=Muitas%20vezes%20uma%20solu%c3%a7%c3%a3o%20intuitiva%20n%c3%a3o%20%c3%a9%20exatamente%20o%20que%20esperamos%20que%20seja%20quando%20o%20c%c3%b3digo%20est%c3%a1%20rodando.%20Gerar%20IDs...%20http%3a%2f%2fwww.caloni.com.br%2fgettickcount-nao-e-um-gerador-de-ids-unicos%2f from @caloni " style="text-decoration: underline;" title="Twitter">twitter</big></a>


        </div>

        <div class="navigation-bottom">
            <span style="float: right;"><a href="http://www.caloni.com.br/e-ai-comeu/">E Aí... Comeu?<span class="icon"><i class="fa fa-arrow-right"></i></span></a></span>
<span style="float: left;"><a href="http://www.caloni.com.br/prometheus/"><span class="icon"><i class="fa fa-arrow-left"></i></span>Prometheus</a></span>

        </div>

      </div>

    <footer class="footer">
  <div class="container">
    <span style="float: right;"><i style="font-size: small;">Blogue do Caloni 2020. Copyright é invenção do capitalismo burguês opressor. Todos os direitos não serão reservados.</i></span>
  </div>
</footer>

  </body>

</html>
