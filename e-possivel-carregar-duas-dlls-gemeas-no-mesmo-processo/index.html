<!DOCTYPE html>
<html lang="en-us" dir="ltr" itemscope itemtype="http://schema.org/Article">

  <head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Blogue do Caloni - É possível carregar duas DLLs gêmeas no mesmo processo?</title>
  <meta name="author" content="" />
  <meta name="description"
        content="Um dos últimos artigos de Dmitry Vostokov, e tenho que falar assim porque o cara escreve muito em pouco tempo, fala sobre os perigos de termos uma mesma DLL carregada duas vezes em um único processo,..."/>

  <meta name="generator" content="Hugo 0.67.1" />

  
  <meta itemprop="name" content="É possível carregar duas DLLs gêmeas no mesmo processo?"/>
  <meta itemprop="description"
        content="Um dos últimos artigos de Dmitry Vostokov, e tenho que falar assim porque o cara escreve muito em pouco tempo, fala sobre os perigos de termos uma mesma DLL carregada duas vezes em um único processo,..."/>
  <meta itemprop="image"
        content=""/>

  
  <meta property="og:title" content="É possível carregar duas DLLs gêmeas no mesmo processo?"/>
  <meta property="og:type"
        content="article"/>
  <meta property="og:url" content="http://www.caloni.com.br/e-possivel-carregar-duas-dlls-gemeas-no-mesmo-processo/"/>
  <meta property="og:image"
        content=""/>
  <meta property="og:description"
        content="Um dos últimos artigos de Dmitry Vostokov, e tenho que falar assim porque o cara escreve muito em pouco tempo, fala sobre os perigos de termos uma mesma DLL carregada duas vezes em um único processo,..."/>
  <meta property="og:site_name" content="Blogue do Caloni"/>
  <meta property="article:published_time"
        content="2008-06-21T00:00:00&#43;00:00"/>
  <meta property="article:section" content="post"/>

  
  
  <meta name="twitter:card" content="summary"/>
  <meta name="twitter:site"
        content=""/>
  <meta name="twitter:title" content="É possível carregar duas DLLs gêmeas no mesmo processo?"/>
  <meta name="twitter:description"
        content="Um dos últimos artigos de Dmitry Vostokov, e tenho que falar assim porque o cara escreve muito em pouco tempo, fala sobre os perigos de termos uma mesma DLL carregada duas vezes em um único processo,..."/>
  <meta name="twitter:creator"
        content=""/>
  <meta name="twitter:image:src"
        content="
                     /images/movies.png
                   "/>

  
  <link href="" rel="alternate" type="application/rss+xml"
        title="Blogue do Caloni"/>
  <link href="" rel="feed" type="application/rss+xml"
        title="Blogue do Caloni"/>

  
  <link rel="stylesheet" type="text/css" href="/css/capsule.min.css"/>
  
  <link rel="stylesheet" type="text/css" href="/css/custom.css"/>

  
  <script>
  
    
      <!-- Google Analytics -->
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
      ga('create', 'UA-50557403-2', 'auto');
      ga('send', 'pageview');
    
  
  </script>
  <script src="/js/jquery.min.js"></script>
  <script src="/js/list.js"></script>

  
  <link rel="icon" href="/favicon.ico"/>
  </head>


  <body style="min-height:100vh;display:flex;flex-direction:column">

    <nav class="navbar has-shadow is-white"
     role="navigation" aria-label="main navigation">
  <div class="container">

    <div class="navbar-brand">
      <a class="navbar-item" title="Go to Home" href="/">
        <img alt="Brand" src="/brand.svg">
        <div class="title is-6">&nbsp;Blogue do Caloni</div>
      </a>

      
      <label class="button navbar-burger is-white" for="navbar-burger-state">
        <span></span>                               
        <span></span>
        <span></span>
      </label>
    </div>

    
    <input type="checkbox" id="navbar-burger-state"/>

    <div class="navbar-menu">
      <div class="navbar-end" style="padding: 10px;">
      <big><b>
       <a title="posts dessa categoria" href="/categories/blog">blog</a>  <a title="posts dessa categoria" href="/categories/cinema">cinema</a>  <a title="posts dessa categoria" href="/categories/code">code</a> 
       <a href="/caloni"><span class="icon"><i class="fa fa-user"></i></a> <a href="index.xml"><span class="icon"><i class="fa fa-rss"></i></a>
      </big></b>
      </div>
    </div>

  </div>
</nav>


      
      <div class="container">
        <p class="title">É possível carregar duas DLLs gêmeas no mesmo processo?</p>

        <p class="subtitle">
<i>

    <a href="https://github.com/Caloni/post/commits/master/e-possivel-carregar-duas-dlls-gemeas-no-mesmo-processo.md" title="History">
    2008-06-21
    </a>

<span class="icon"><i class="fa fa-clock-o"></span></i>3 </i>
 <span class="icon"><i class="fa fa-pencil"></i></span><a href="https://github.com/Caloni/post/blob/master/e-possivel-carregar-duas-dlls-gemeas-no-mesmo-processo.md" title="GitHub">588</a>
</p>

        <div class="taglist">
            <i>Este ainda é um rascunho publicado prematuramente e está sujeito a mudanças substanciais.</i>

        </div>

        

        
          <div class="content">
            
              <p>Um dos últimos artigos de Dmitry Vostokov, e tenho que falar assim porque o cara escreve muito em pouco tempo, fala sobre os perigos de termos uma mesma DLL carregada duas vezes em um único processo, muitas vezes em versões diferentes. Para os observadores atentos como Dmitry esse é um perigo que muitas vezes temos que estar preparados. Para os espertinhos de plantão, a resposta padrão seria: &ldquo;não vou me preocupar, porque o contador de instâncias cuida disso&rdquo;.</p>
<p>Será mesmo tão simples?</p>
<p>Vamos supor um caso bem simples e plausível, que é exatamente o mesmo do artigo do Crash Dump Analysis: um produto qualquer possui dois pontos em que ele carrega a mesma DLL. Contudo, no primeiro ponto é usado um caminho relativo, dentro da pasta DLL; na segunda chamada é usado o caminho atual. Se existir de fato duas DLLs, mesmo que idênticas, nesses lugares, então teremos duas instâncias da &ldquo;mesma DLL&rdquo; carregadas no processo.</p>
<p>O código do aplicativo apenas tenta carregar a DLL em dois lugares distintos e exibe o endereço para onde elas foram mapeadas em nosso processo de teste:</p>
<pre><code>#include &lt;windows.h&gt;
#include &lt;stdio.h&gt;

int main()
{
    HMODULE dll1 = LoadLibrary(&quot;.\\DLL\\DLL.dll&quot;);
    HMODULE dll2 = LoadLibrary(&quot;.\\DLL.dll&quot;);

    printf(&quot;First DLL: %p\nSecond DLL: %p&quot;,
            dll1, dll2);

    return 0;
}
</code></pre>
<p>A DLL é uma DLL trivial:</p>
<pre><code>#include &lt;windows.h&gt;

BOOL WINAPI DllMain(HINSTANCE inst, DWORD reason, PVOID reserv)
{
    return TRUE;
}
</code></pre>
<p>Vamos aos testes.</p>
<p>Nesse caso, ambos os retornos serão nulos, que é o natural e esperado quando a DLL não pode ser encontrada nos lugares especificados pelo sistema e pelo aplicativo.</p>
<pre><code>K:\Docs\Projects&gt;cl app.c
Microsoft (R) 32-bit C/C++ Optimizing Compiler Version 14.00.50727.42 for 80x86
Copyright (C) Microsoft Corporation.  All rights reserved.
app.c
Microsoft (R) Incremental Linker Version 8.00.50727.42
Copyright (C) Microsoft Corporation.  All rights reserved.
/out:app.exe
app.obj
K:\Docs\Projects&gt;app
First DLL: 00000000
Second DLL: 00000000
K:\Docs\Projects&gt;
</code></pre>
<p>No segundo caso, a DLL é carregada com sucesso se usado o caminho relativo, pois o caminho atual faz parte da lista de caminhos que o sistema percorre para encontrá-la. A primeira chamada deve falhar.</p>
<pre><code>K:\Docs\Projects&gt;cl /LD dll.c
Microsoft (R) 32-bit C/C++ Optimizing Compiler Version 14.00.50727.42 for 80x86
Copyright (C) Microsoft Corporation.  All rights reserved.
dll.c
Microsoft (R) Incremental Linker Version 8.00.50727.42
Copyright (C) Microsoft Corporation.  All rights reserved.
/out:dll.dll
/dll
/implib:dll.lib
dll.obj
K:\Docs\Projects&gt;app
First DLL: 00000000
Second DLL: 10000000
K:\Docs\Projects&gt;
</code></pre>
<p>No caso problemático, a mesma DLL é carregada em dois endereços distintos da memória do mesmo processo, o que pode causar sérios problemas dependendo do código envolvido.</p>
<pre><code>K:\Docs\Projects&gt;mkdir DLL
K:\Docs\Projects&gt;copy dll.dll DLL
1 arquivo(s) copiado(s).
K:\Docs\Projects&gt;app
First DLL: 10000000
Second DLL: 00350000
K:\Docs\Projects&gt;
</code></pre>
<p>Apesar do mundo parecer injusto, temos uma segunda regra que podemos usar para aqueles casos onde a idiotisse já foi feita:</p>
<p>Vamos supor que estamos no meio de uma mudança bem radical no produto e queremos ter certeza que qualquer chamada à nossa DLL irá invocar unicamente a que estiver dentro do caminho do produto (caminho atual). Para esse caso o Windows permite uma saída muito interessante, que é o uso de um arquivo com o nome do aplicativo mais o sufixo &ldquo;.local&rdquo;. Se esse arquivo existir, de acordo com o MSDN.aspx), então qualquer chamada à DLL irá ter sempre a prioridade do caminho atual.</p>
<pre><code>K:\Docs\Projects&gt;copy con app.exe.local
^Z
1 arquivo(s) copiado(s).
K:\Docs\Projects&gt;app
First DLL: 10000000
Second DLL: 10000000
K:\Docs\Projects&gt;
</code></pre>
<p>Tente evitar a replicação do mesmo arquivo em diversos lugares. Quando eu digo &ldquo;mesmo arquivo&rdquo; me refiro ao mesmo nome de DLL, embora não necessariamente a mesma versão. Isso pode evitar algumas dores de cabeça futuras. E muitas, muitas horas de depuração.</p>

            

          </div>

        <div class="taglist">
            
    
      [<a href="/categories/code">code</a>] 
      [<a href="/tags/draft">draft</a>] 
    
    <a href="https://twitter.com/intent/tweet?text=Um%20dos%20%c3%baltimos%20artigos%20de%20Dmitry%20Vostokov%2c%20e%20tenho%20que%20falar%20assim%20porque%20o%20cara%20escreve%20muito%20em%20pouco%20tempo%2c%20fala...%20http%3a%2f%2fwww.caloni.com.br%2fe-possivel-carregar-duas-dlls-gemeas-no-mesmo-processo%2f from @caloni " style="text-decoration: underline;" title="Twitter">twitter</big></a>


        </div>

        <div class="navigation-bottom">
            <span style="float: right;"><a href="http://www.caloni.com.br/como-estou-trabalhando-com-o-bazaar/">Como estou trabalhando com o Bazaar<span class="icon"><i class="fa fa-arrow-right"></i></span></a></span>
<span style="float: left;"><a href="http://www.caloni.com.br/alinhamento-de-memoria-portavel/"><span class="icon"><i class="fa fa-arrow-left"></i></span>Alinhamento de memória portável</a></span>

        </div>

      </div>

    <footer class="footer">
  <div class="container">
    <span style="float: right;"><i style="font-size: small;">Blogue do Caloni 2020. Copyright é invenção do capitalismo burguês opressor. Todos os direitos não serão reservados.</i></span>
  </div>
</footer>

  </body>

</html>
