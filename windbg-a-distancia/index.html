<!DOCTYPE html>
<html lang="en-us" dir="ltr" itemscope itemtype="http://schema.org/Article">

  
  
      
  
      
  

  <head>
  <meta charset="utf-8" />

  
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Blogue do Caloni - WinDbg a distância</title>
  <meta name="author" content="" />

  <meta name="generator" content="Hugo 0.67.1" />

  
  <meta property="og:title" content="WinDbg a distância"/>
  <meta property="og:type"
        content="article"/>
  <meta property="og:url" content="http://www.caloni.com.br/windbg-a-distancia/"/>
  <meta property="og:image"
        content="/img/author.jpg"/>
  <meta property="og:description"
        content="Acho que o que mais me impressionou até hoje a respeito do WinDbg é a sua capacidade de depuração remota. Não há nada como depurar problemas sentado confortavelmente na sua cadeira de programador em..."/>

  
  <link href="" rel="feed" type="application/rss+xml"
        title="Blogue do Caloni"/>

  
  
  <link rel="stylesheet" type="text/css" href="/css/custom.css"/>

  
  <script>
  
    
      <!-- Google Analytics -->
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
      ga('create', 'UA-50557403-2', 'auto');
      ga('send', 'pageview');
    
  
  </script>
  <script src="/js/jquery.min.js"></script>
  <script src="/js/list.js"></script>

  
  <link rel="icon" href="/img/favicon.ico"/>
  </head>


  <body style="min-height:100vh;display:flex;flex-direction:column">

    <nav class="navbar has-shadow is-white"
     role="navigation" aria-label="main navigation">

  <div class="container">

    <div class="navbar-brand">
        <img alt="Brand" src="/img/brand.svg">
        &nbsp;
        <a class="navbar-item" title="Go to Home" href="/">
            <div class="is-6">Blogue do Caloni</div>
        </a>
    </div>

    

  </div>
</nav>


      
      <div class="container">
        <p class="title">

WinDbg a distância

</p>

        <p class="subtitle">

  Wanderley Caloni,
  
    
  
    
  
  <a href="https://github.com/Caloni/blog/blob/master/content/posts/windbg-a-distancia.md">2008-03-26</a>

</p>

        

        
          <div class="content">

            
              <p>Acho que o que mais me impressionou até hoje a respeito do WinDbg é a sua capacidade de depuração remota. Não há nada como depurar problemas sentado confortavelmente na sua cadeira de programador em frente à sua mesa de programador.</p>
<p>Já é fato consumado que os maiores problemas da humanidade ocorrem sempre no cliente, com uma relação de dificuldade diretamente proporcional ao cargo ocupado pelo usuário da máquina que está dando problemas. Se esse cliente por acaso mora em um lugar tão tão distante, nada mais justo do que conhecermos algumas técnicas de depuração remota para continuar a mantê-lo tão tão distante.</p>
<h4 id="testes-de-corredor-corre-que-o-bicho-tá-pegando">Testes de corredor: corre que o bicho tá pegando!</h4>
<p>O <strong>ambiente de desenvolvimento</strong> (em teoria) não se deve confundir com o <strong>ambiente de testes</strong>, um lugar onde o desenvolvedor deveria colocar o pé somente quando fosse chamado e quando existisse um problema na versão <em>Release</em>. Por isso e portanto, a única coisa permitida em um ambiente de testes é (deveria ser) um <strong>servidor de depuração</strong>.</p>
<p>O servidor de depuração nada mais é do que um processo que deixa alguma porta aberta  na máquina de testes para que o desenvolvedor consiga facilmente depurar problemas que ocorreram durantes os testes de produção. Ele pode ser facilmente configurado através da instalação do pacote <a href="http://www.microsoft.com/whdc/devtools/debugging/default.mspx">Debugging Tools for Windows</a>.</p>
<p>Existem alguns cenários muito comuns de depuração remota que serão abordados aqui. O resto dos cenários se baseia nos exemplos abaixo, e pode ser montado com uma simples releitura dos tópicos de ajuda do WinDbg sobre o assunto (procure por <strong>dbgsrv.exe</strong>).</p>
<h4 id="1-depuração-de-teste-vm-ou-máquina-de-teste-do-lado-do-desenvolvedor">1. Depuração de teste (VM ou máquina de teste do lado do desenvolvedor)</h4>
<p>Nesse caso podemos supor que a máquina tem total acesso e controle do desenvolvedor. Tudo o que temos que fazer é iniciar um WinDbg na <strong>máquina-vítima</strong> e outro WinDbg na <strong>máquina-programador</strong>. O WinDbg da máquina-vítima deve ser iniciado no <strong>modo-servidor</strong>, enquanto o da máquina-programador no <strong>modo-cliente</strong>.</p>
<pre><code>windbg -&lt;strong&gt;server&lt;/strong&gt; tcp:port=6666
windbg -&lt;strong&gt;remote &lt;/strong&gt;tcp:server=&lt;strong&gt;maquina-vitima&lt;/strong&gt;,port=6666
</code></pre>
<p>A vantagem dessa técnica é que tanto o WinDbg da máquina-vítima quanto o da máquina-programador podem <strong>emitir comandos</strong>, e todos vêem os resultados. Uma possível desvantagem é que <strong>os símbolos devem estar disponíveis a partir da máquina-vítima</strong>.</p>
<p>Se for necessário, é possível convidar mais gente pra festa, pois o WinDbg permite se transformar em uma instância servidora pelo comando <strong>.server</strong>, que possui a mesma sintaxe da linha de comando. Para a comunicação entre todos esses depuradores ambulantes um comando muito útil é o <strong>.echo</strong>.</p>
<pre><code>windbg -server tcp:port=6667 -remote tcp:server=maquina-vitima,port=6666


windbg -remote tcp:server=maquina-vitima,port=6666
.server tcp:port=6667


MAQUINA-PROGRAMADOR66\caloni (tcp 222.234.235.236:1974) connected at Mon Mar 24 11:47:55 2008


.echo E ae, galera? Como que a gente vai consertar essa &amp;%$*&amp;?
.echo Putz, sei lá. Acho que vou tomar mais café...
</code></pre>
<p><img src="http://i.imgur.com/DFnxGQC.gif" alt="Windbg Remote"></p>
<h4 id="2-depuração-em-cliente">2. Depuração em cliente</h4>
<p>Nesse ambiente muito mais hostil, é salutar e recomendável utilizar um <strong>servidor genérico</strong> que não imprima coisa alguma na tela &quot;do outro lado&quot;. Após iniciar o depurador na máquina que está dando o problema, o programador tem virtualmente uma série de comandos úteis que podem ser executados remotamente, como iniciar novos processos, se anexar a processos já existentes, copiar novas versões de executáveis, etc.</p>
<p>O nome do processo do lado servidor para modo usuário é <strong>dbgsrv.exe</strong>. Para o modo <em>kernel</em> é <strong>kdsrv.exe</strong>. Os parâmetros de execução, felizmente, são os mesmos que os do WinDbg (e CDB, NTSD e KD), o que evita ter que decorar uma nova série de comandos.</p>
<!-- raw HTML omitted -->
<blockquote>
<h4 id="lembre-se-_kernel_-é-_kernel_-_user_-é-_user_">Lembre-se: <em>kernel</em> é <em>kernel</em>, <em>user</em> é <em>user</em></h4>
</blockquote>
<p>Pode parecer besteira falar isso aqui, mas ao depurar um sistema em modo <em>kernel</em> é necessário, é claro, é óbvio, é lógico, ter uma segunda máquina do lado servidor conectada por cabo serial ou <em>firewire</em> ou USB-Debug na máquina-vítima. Ainda que o Debugging Tools permita uma série de flexibilidades, o depurador em modo <em>kernel</em> vai rodar direto do <em>kernel</em> (duh), ou seja, está limitado pela implementação do sistema operacional. Além de que, para travar o processo do <em>kernel</em>, você tem que parar todo o sistema, e nesse caso não existe pilha TCP/IP.<!-- raw HTML omitted --></p>
<p>Para iniciar o servidor de depuração e deixar as portas abertas para o depurador temos apenas que iniciar o processo dbgsrv.exe:</p>
<pre><code>dbgsrv -t tcp:port=6666
</code></pre>
<p>Para iniciar o processo depurador, a sintaxe é quase a mesma, só que no lugar de remote especificamos <strong>premote</strong>:</p>
<pre><code>windbg -premote tcp:server=maquina-vitima,port=6666
</code></pre>
<p>Caso não se saiba a porta usada para iniciar o servidor, ou queira-se listar todos os servidores disponíveis em uma determinada máquina, usa-se o comando -QR.</p>
<pre><code>cdb -QR \\maquina-vitima
</code></pre>
<!-- raw HTML omitted -->
<blockquote>
<h4 id="não-se-prenda-ao-tcp-ip">Não se prenda ao TCP-IP</h4>
</blockquote>
<p>O exemplo acima utilizou uma conexão TCP para montar o ambiente de depuração remota, o que possibilita inclusive correção de problemas via internet. No entanto, nem sempre podemos nos dar ao luxo de abrir portas não-autorizadas, requisito mínimo para estabelecer a conexão com o depurador. Nesse caso, podemos configurar conexões pela porta serial, por <em>pipes</em> nomeados, por SSL. Se for realmente necessário usar a pilha TCP, mas o lado servidor possui um <em>firewall</em>, ainda assim é possível configurar este tipo de conexão com a opção <strong>clicon</strong>. Dessa forma, quem estabelece a conexão é o servidor, evitando que o cliente fique bloqueado de acessar o ambiente de depuração.<!-- raw HTML omitted --></p>
<p><img src="http://i.imgur.com/tIbty17.gif" alt="Windbg Remote"></p>
<h4 id="notas-finais">Notas finais</h4>
<p>É importante notar que o dbgsrv.exe não é um depurador esperto, no sentido que ele não vai carregar os símbolos para você. Isso é importante na hora de definir qual estratégia utilizar, pois nem sempre os símbolos estarão disponíveis na máquina com problemas, e nem sempre estarão com o desenvolvedor.</p>
<p>Uma organização mais esperta dos ambientes de teste e desenvolvimento tomaria conta de outros problemas como símbolos e fontes com o uso de outras <em>features</em> poderosas do Debugging Tools como servidor de símbolos e servidor de fontes. Porém, a complicação envolvida na configuração desses dois me leva a crer que eles merecem um outro artigo. E é por isso que paramos por aqui.</p>

            

          </div>

        <div class="taglist">
            
    
      <a href="/tags/draft">draft</a>  <a href="/tags/blog">blog</a> 
    <a class="externalgray" href="https://telegram.me/share/url?url=http://www.caloni.com.br/windbg-a-distancia/">discuss</a>


        </div>

        <div class="navigation-bottom">
            <span class="next-in-section"><a href="http://www.caloni.com.br/backup-de-pobre/">&#x25C1; Backup de pobre</a></span>
<span class="prev-in-section"><a href="http://www.caloni.com.br/depuracao-da-mbr/">&#x25B7; Depuração da MBR</a></span>

        </div>

      </div>

    <footer class="footer">
  <div class="container">
    <span style="float: right;"><i style="font-size: small;">Blogue do Caloni <a href="https://github.com/Caloni/blog">2021.04.19</a> </i></span>
  </div>
</footer>

  </body>

</html>
